---
title: "Whole Lung Tissue vs. BAL Fluid 16S Sequencing Analysis (Trimmed/QC'd Final Dataset)"
author: "Jennifer M. Baker"
date: "August 18, 2020 (updated)"
output:
  pdf_document: 
    latex_engine: xelatex
  html_document:
    code_folding: "show"
---

```{r rmd_setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, # whether code should be displayed in document - TRUE for code folding on html
                      cache = TRUE, # whether to cache results of code chunks for future knits
                      fig.align = 'left', # alignment options: 'left', 'right', 'center', 'default'
                      error = TRUE, # display error messages in document (TRUE) or stop render on error (FALSE)
                      warning = FALSE, # do not print code warning messages in Rmd file
                      message = FALSE, # do not print code messages
                      comment = "", # string that precedes results, in this case, an empty string (default is ##)
                      results = "hold" # hold all outputs until end of code chunk 
                      )
```

```{r libraries}
# Libraries used in this analysis 

# I. universal data wrangling and visualization
library(tidyverse)      # ggplot, dplyr, purrr, forcats, stringr, etc. See https://tidyverse.tidyverse.org/
library(tidyselect)     # useful for subsetting dataframes 
library(gtools)

# II. formatting, plotting
library(scales)         # used in formatting relative abundance % labels; dollar_format()
library(knitr)          # necessary for kable, for displaying nicer tables in html/pdf output
library(ggplot2)        # customizable data visualization
library(ggpubr)         # data visualization, built on ggplot2

# III. analysis packages
library(vegan)          # decostand(), metaMDS(), scores(), rda(), ordispider(), adonis()
library(ape)            # pcoa()

# IV. functions for automating and streamlining workflow
# library(devtools)
# devtools::install_github("https://github.com/cb-42/cbmbtools")
library(cbmbtools)

#V. Rmarkdown formatting
library(pander) # format session info

```

### This report was created with: 
```{r session info} 
pander(sessionInfo()) 
```

```{r custom functions}
# function for computing summary statistics - error bar helper
sem <- function(x){
  sqrt(var(x, na.rm = TRUE)/length(na.omit(x)))
}

```

```{r set_seed}

set.seed(3132)

```

```{r load & prep 16S ddPCR quantification data, include = FALSE}

ddpcr <- read.csv("WholeLung_v_BALF_16S_ddPCR_quantification.csv", header=T, stringsAsFactors = T)
colnames(ddpcr) <- c("Sample", "Gene_16S_copies_per_specimen")

ddpcr <- mutate(ddpcr, Sample_Type = factor(case_when(
                                              str_detect(Sample, "BAL_") ~ "BAL", 
                                              str_detect(Sample, "Lung_") ~ "Lung", 
                                              str_detect(Sample, "PBS_") ~ "PBS",
                                              str_detect(Sample, "HomogCtrl_") ~ "Homog_Ctrl", 
                                              str_detect(Sample, "_RINSE") ~ "Syringe_Rinse",
                                              str_detect(Sample, "IsoCtrl") ~ "Iso_Ctrl",
                                              str_detect(Sample, "NTC") ~ "NTC"
        ), levels = c("NTC", "Iso_Ctrl", "PBS", "Syringe_Rinse", "Homog_Ctrl", "BAL", "Lung")
      )
    ) %>% 
  
  dplyr::select(Sample_Type, everything())


```

# I. 16S rRNA gene amplicon quantification 
```{r plot_16S_ddPCR_quantification, fig.height=5, fig.width=8}
#data prep
ddpcr <- ddpcr %>% group_by(Sample_Type)

ddpcr.summary <- summarize(ddpcr, 
                            Mean=mean(Gene_16S_copies_per_specimen), 
                            SEM=sqrt(var(Gene_16S_copies_per_specimen)/length(Gene_16S_copies_per_specimen)))

#pdf("Figure2.pdf", width = 8, height = 6, useDingbats = FALSE)
ggplot(ddpcr, aes(x=Sample_Type)) + 
  geom_col(data=ddpcr.summary, aes(x=Sample_Type, y=Mean, fill=Sample_Type), color= "black", show.legend = FALSE) +
  geom_point(aes(x=Sample_Type, y=Gene_16S_copies_per_specimen)) +
  geom_errorbar(data=ddpcr.summary, aes(ymin = Mean-SEM, ymax = Mean+SEM, width = 0.3)) + 
  theme_classic() + 
  scale_y_log10(
   limits = c(10^0, 10^6),
   breaks = scales::trans_breaks("log10", function(x) 10^x),
   labels = scales::trans_format("log10", scales::math_format(10^.x)), expand = c(0,0)) + 
theme(axis.text.y = element_text(size=12), 
      axis.text.x = element_text(size=10), 
      axis.title.y = element_text(size=12, face="bold", angle = 0, vjust=0.5), 
      axis.title.x = element_text(size=12, face="bold"), 
      plot.margin = unit(c(0.5,0.5,0.5,0.5), "cm")) + 
ylab("16S rRNA Gene\nCopies/specimen") +
xlab("\nSample Type") 
#dev.off()


```

## Hypothesis testing - 16S rRNA gene amplicon quantification
```{r 16S ddPCR quantification - hypothesis testing}
#overall difference between groups - kruskal wallis test for multiple group comparisons 
kruskal.test(Gene_16S_copies_per_specimen ~ Sample_Type, data=ddpcr)

#pairwise difference between groups - Wilcoxon rank sum test, adjusted for multiple comparisons
pairwise.wilcox.test(ddpcr$Gene_16S_copies_per_specimen, ddpcr$Sample_Type, p.adjust.method = "BH")

```

```{r load MiSeq read counts, include=FALSE}

miseq_reads <- read.csv("WholeLung_v_BALF_MiSeq_Reads_Final.csv", header = TRUE, sep = ",", stringsAsFactors = TRUE)

```

```{r load & prep 16S sequencing data, message = FALSE, include = FALSE}

# Basic processing with selection of OTUs > 0.1 % of the population in each bacterial community
# Read in opti_mcc.shared
otu_good <- load_shared("WholeLung_v_BALF.shared")

# Trim _S from end of rownames(otu_good), inspect data, and convert to dataframe
rownames(otu_good) <- str_remove(rownames(otu_good), "_S\\d+_L001_R1_001") %>% str_remove("_S\\d+_L001_R1")
dim(otu_good) # dim(otu_good)[1] observations (samples) x dim(otu_good)[2] features (OTUs above .1% population threshold)
#[1] 120 773
otu_good <- as.data.frame(otu_good)

# II. Read in cons.taxonomy and inspect data 
otu_good_taxonomy <- load_tax("WholeLung_v_BALF.cons.taxonomy", otu_good = otu_good)
dim(otu_good_taxonomy)
#[1] 773   7

#untrimmed dataset for diversity metrics 
otu_raw <- read.table("WholeLung_v_BALF.shared", row.names = 2, header = T, stringsAsFactors = T)
otu_trim <- otu_raw[, -c(1:2)] # remove unnecessary columns 
otu_untrimmed <- as.matrix(otu_trim) # convert to matrix 
rownames(otu_untrimmed) <- str_remove(rownames(otu_untrimmed), "_S\\d+") # clean up sample names
otu_untrimmed <- as.data.frame(otu_untrimmed) # convert to dataframe
dim(otu_untrimmed) # inspect data 
#[1]  120 3391

# Read in cons.taxonomy table for use with the untrimmed version of sequencing data & inspect data 
otu_untrimmed_taxonomy <- load_tax("WholeLung_v_BALF.cons.taxonomy", otu_good = otu_untrimmed)
dim(otu_untrimmed_taxonomy) 
#[1]  3391    7

###optional datasets for exploratory analysis 
#uncomment and run indicated lines below to see rest of results at each step of quality thresholding

# untrimmed dataset (full dataset post-mothur, no OTUs or samples were omitted) 
#this code is used in main analysis for diversity metrics and is replicated above 
#uncomment and run this chunk of code to see results for untrimmed dataset
#will also need to comment out the quality check chunk of code following analysis of MiSeq reads
# otu_raw <- read.table("WholeLung_v_BALF.shared", row.names = 2, header = T, stringsAsFactors = T)
# otu_trim <- otu_raw[, -c(1:2)] # remove unnecessary columns
# otu_untrimmed <- as.matrix(otu_trim) # convert to matrix
# rownames(otu_untrimmed) <- str_remove(rownames(otu_untrimmed), "_S\\d+_L001_R1_001") %>% str_remove("_S\\d+_L001_R1") # clean up sample names
# otu_untrimmed <- as.data.frame(otu_untrimmed) # convert to dataframe
# dim(otu_untrimmed) # inspect data #[1]  120 3391
# otu_good <- otu_untrimmed
# otu_untrimmed_taxonomy <- load_tax("WholeLung_v_BALF.cons.taxonomy", otu_good = otu_untrimmed)
# dim(otu_untrimmed_taxonomy)
# otu_good_taxonomy <- otu_untrimmed_taxonomy #[1]  3391    7



# trimmed dataset (dataset post-mothur that has been trimmed to omit OTUs < 0.1% of the sample population)
#uncomment and run this chunk of code to see results for trimmed dataset
#will also need to comment out the quality check chunk of code following analysis of MiSeq reads
# otu_good <- load_shared("WholeLung_v_BALF.shared")
# rownames(otu_good) <- str_remove(rownames(otu_good), "_S\\d+_L001_R1_001") %>% str_remove("_S\\d+_L001_R1")
# dim(otu_good) #[1] 120 773
# otu_good <- as.data.frame(otu_good)



# quality-checked dataset (dataset post-mothur, OTUs >0.1% of each sample population, and filtered out samples < 100 reads)
# this is the final dataset used in the main analysis - no extra code needed

```

```{r create OTU dataframe with metadata and normalized counts, include = FALSE}
# Convert OTU counts to percentages and create metadata from sample names
otu_df <- data.frame(decostand(otu_good, "total") * 100) %>%
  mutate(Sample = rownames(otu_good)) %>% 
  
  mutate(Sample_Type = factor(case_when(
                                       str_detect(Sample, "^WVB_BAL") ~ "BAL", 
                                       str_detect(Sample, "^WVB_HomogCtrl") ~ "Homog_Ctrl",
                                       str_detect(Sample, "^WVB_Lung") ~ "Lung", 
                                       str_detect(Sample, "^AE_") ~ "AE",
                                       str_detect(Sample, "^Blank_") ~ "Empty",
                                       str_detect(Sample, "J_IsoCtrl") ~ "Iso_Ctrl",
                                       str_detect(Sample, "^Water") ~ "Water",
                                       str_detect(Sample, "^ZymoMock") ~ "Mock",
                                       str_detect(Sample, "^WVB_CLEAN_RINSE") ~ "Clean_Rinse",
                                       str_detect(Sample, "^WVB_USED_RINSE") ~ "Used_Rinse",
                                       str_detect(Sample, "^WVB_PBS") ~ "PBS", 
                                       str_detect(Sample, "^WVB_Tongue") ~ "Tongue", 
                                       str_detect(Sample, "WVB_Cecum") ~ "Cecum"
                                       ), levels = c("BAL", "Lung", "AE", "Empty", "Iso_Ctrl", "Water", "Mock", "Homog_Ctrl", "PBS", "Clean_Rinse", "Used_Rinse", "Tongue", "Cecum")
                                     )
         ) %>%
  
  mutate(Sample_Type2 = factor(case_when(
                                              str_detect(Sample, "BAL_") ~ "BAL", 
                                              str_detect(Sample, "Lung_") ~ "Lung", 
                                              str_detect(Sample, "PBS_") ~ "PBS",
                                              str_detect(Sample, "HomogCtrl_") ~ "Homog_Ctrl", 
                                              str_detect(Sample, "_RINSE") ~ "Syringe_Rinse",
                                              str_detect(Sample, "IsoCtrl") ~ "Iso_Ctrl",
                                              str_detect(Sample, "^AE_") ~ "AE",
                                              str_detect(Sample, "^Blank_") ~ "Empty",
                                              str_detect(Sample, "^Water") ~ "Water",
                                              str_detect(Sample, "^ZymoMock") ~ "Mock",
                                              str_detect(Sample, "^WVB_Tongue") ~ "Tongue", 
                                              str_detect(Sample, "WVB_Cecum") ~ "Cecum"
        )
      )
    ) %>% 
  
  mutate(RA_Groups = factor(case_when(
                str_detect(Sample_Type, "Lung") ~ "Lung",
                str_detect(Sample_Type, "BAL") ~ "BAL",
                str_detect(Sample_Type, 
                           "AE|Iso_Ctrl|Empty|Water|PBS|Clean|Used|Homog") ~ "Negative Control"))) %>%

  mutate(Organ = factor(case_when(
                                  str_detect(Sample_Type, "Cecum") ~ "Cecum",
                                  str_detect(Sample_Type, "BAL") ~ "Lung",
                                  str_detect(Sample_Type, "Tongue") ~ "Tongue",
                                  str_detect(Sample_Type, "Lung") ~ "Lung", 
                                  str_detect(Sample_Type, "Homog_Ctrl") ~ "Sampling Control", 
                                  str_detect(Sample_Type, "PBS") ~ "Sampling Control", 
                                  str_detect(Sample_Type, "Clean_Rinse") ~ "Sampling Control", 
                                  str_detect(Sample_Type, "Used_Rinse") ~ "Sampling Control", 
                                  str_detect(Sample_Type, "AE") ~ "Isolation Control",
                                  str_detect(Sample_Type, "Iso_Ctrl") ~ "Isolation Control",
                                  str_detect(Sample_Type, "Water") ~ "Sequencing Control", 
                                  str_detect(Sample_Type, "Mock") ~ "Sequencing Control", 
                                  str_detect(Sample_Type, "Empty") ~ "Sequencing Control"
                                 ),
                 )
        ) %>% 
  
  mutate(Blank_Plate = factor(case_when(
                                        str_detect(Sample, "^Blank_C_") ~ "Plate C",
                                        str_detect(Sample, "^Blank_D_") ~ "Plate D"
                                      ),
                                     )
        ) %>% 
  mutate(Cage = factor(case_when(
                                 str_detect(Sample, "_B[1|2]$") ~ "Cage A", 
                                 str_detect(Sample, "_L[1|2|3]$") ~ "Cage A", 
                                 str_detect(Sample, "_B[3|4]$") ~ "Cage B", 
                                 str_detect(Sample, "_L[4|5|6]$") ~ "Cage B", 
                                 str_detect(Sample, "_B[5|6|7]$") ~ "Cage C", 
                                 str_detect(Sample, "_L[7|8]$") ~ "Cage C", 
                                 str_detect(Sample, "_B[8|9]$") ~ "Cage D", 
                                 str_detect(Sample, "_[B|L]10$") ~ "Cage D", 
                                 str_detect(Sample, "_L9$") ~ "Cage D"
                                 ), 
                                )
         ) %>% 
  
  mutate(Experiment = factor(case_when(
                                        str_detect(Sample, "_B\\d+$") ~ "BAL", 
                                        str_detect(Sample, "_L\\d+$") ~ "Lung"
  ))) %>% 
   
  # organize dataframe - metadata columns first, followed by all of the count data
  dplyr::select(Sample:Experiment, everything())
  # note that the data is in wide format

```

```{r add previously loaded metadata to otu_df, include = FALSE}

# add miSeq read counts to otu_df
otu_df <- left_join(otu_df, miseq_reads, by = c("Sample" = "Final.Sample.Name")) %>% dplyr::select(Sample:Experiment, Reads.PF.Sample, everything())

# add ddPCR 16S quantification data to otu_df
ddpcr <- ungroup(ddpcr) 
ddpcr_join <- dplyr::select(ddpcr, Sample, Gene_16S_copies_per_specimen)
otu_df <- left_join(otu_df, ddpcr_join, by = "Sample") %>% 
  dplyr::select(Sample:Reads.PF.Sample, Gene_16S_copies_per_specimen, everything())

```


# II. Quality Checks - Confirmation of Sufficient Reads 
## 2.1 MiSeq Reads by Sample Type
```{r plot_ReadsPF_by_sample_type, fig.height=5, fig.width=12}

#prepare data for plotting 
reads.by.sample.type.df <- otu_df

reads.by.sample.type.df$Sample_Type2 <- factor(reads.by.sample.type.df$Sample_Type2, 
                                               levels = c("Mock", "Water", "Empty", "AE", "Iso_Ctrl", "PBS", "Syringe_Rinse", "Homog_Ctrl", "BAL", "Lung", "Tongue", "Cecum"))
                                               
#plot number of MiSeq reads by sample type
ggplot(reads.by.sample.type.df, aes(x=Sample_Type2, y=Reads.PF.Sample)) + 
  geom_boxplot(aes(fill = Sample_Type2), show.legend=FALSE) + 
  geom_point() + 
  theme_classic() +
  scale_y_log10(
   limits = c(10^0, 10^6),
   breaks = scales::trans_breaks("log10", function(x) 10^x),
   labels = scales::trans_format("log10", scales::math_format(10^.x)), expand = c(0,0)) +
theme(axis.text.y = element_text(size=12), 
      axis.text.x = element_text(size=12), 
      axis.title.y = element_text(size=15, face="bold", angle = 0, vjust=0.5), 
      axis.title.x = element_text(size=15, face="bold"), 
      plot.margin = unit(c(0.5,0.5,0.5,0.5), "cm")) + 
ylab("MiSeq\nReads\n(Pass Filter Clusters") +
xlab("\nSample Type") 

```

## 2.2 OTU Counts by Sample Type
```{r plot_OTU_counts_by_sample_type, fig.height=5, fig.width=12}
# prepare data for plotting 
otu.total.counts.byExpt <- bind_cols(otu_df[,c("Sample", "Sample_Type2", "Organ")], OTU_Count = rowSums(otu_good)) %>%
  group_by(Sample_Type2) 

otu.total.counts.byExpt$Sample_Type2 <- factor(otu.total.counts.byExpt$Sample_Type2, 
                                               levels = c("Mock", "Water", "Empty", "AE", "Iso_Ctrl", "PBS", "Syringe_Rinse", "Homog_Ctrl", "BAL", "Lung", "Tongue", "Cecum"))

# plot OTU counts by sample type

ggplot(otu.total.counts.byExpt, aes(x=Sample_Type2, y=OTU_Count)) + 
  geom_boxplot(aes(fill = Sample_Type2), show.legend=FALSE) + 
  geom_point() + 
  theme_classic() +
  scale_y_log10(
   limits = c(10^0, 10^6),
   breaks = scales::trans_breaks("log10", function(x) 10^x),
   labels = scales::trans_format("log10", scales::math_format(10^.x)), expand = c(0,0)) +
theme(axis.text.y = element_text(size=12), 
      axis.text.x = element_text(size=12), 
      axis.title.y = element_text(size=15, face="bold", angle = 0, vjust=0.5), 
      axis.title.x = element_text(size=15, face="bold"), 
      plot.margin = unit(c(0.5,0.5,0.5,0.5), "cm")) + 
ylab("OTU\nCount") +
xlab("\nSample Type") 


```

# 2.3 Bacterial Reads per Sample (post-mothur processing - from raw count table)

```{r plot_raw_counts, fig.height=5, fig.width=12}

#clean up raw count table
otu_raw_plot <- otu_raw
rownames(otu_raw_plot) <-  str_remove(string = rownames(otu_raw_plot), pattern = "_S\\d+_L001_R1_001") %>% str_remove(pattern = "_S\\d+_L001_R1") 
otu_raw_plot <- dplyr::select(otu_raw_plot, -label, -numOtus)

raw_reads_by_sample <- rowSums(otu_raw_plot) %>% as.data.frame() %>% rownames_to_column("Sample")

colnames(raw_reads_by_sample) <- str_replace(string = colnames(raw_reads_by_sample), pattern = "^.$", replacement = "Total_Reads")

otu_df <- full_join(otu_df, raw_reads_by_sample, by = "Sample") %>% 
        dplyr::select(Sample:Reads.PF.Sample, Total_Reads, everything())

otu_df_plot_reads <- otu_df
otu_df_plot_reads$Sample_Type2 <- factor(otu_df_plot_reads$Sample_Type2, 
                                               levels = c("Mock", "Water", "Empty", "AE", "Iso_Ctrl", "PBS", "Syringe_Rinse", "Homog_Ctrl", "BAL", "Lung", "Tongue", "Cecum"))

# plot total reads by sample type
#pdf("Figure_S1.pdf", height = 6, width = 10, useDingbats = FALSE)
ggplot(otu_df_plot_reads, aes(x=Sample_Type2, y=Total_Reads)) + 
  geom_boxplot(aes(fill = Sample_Type2), show.legend=FALSE) + 
  geom_point() + 
  theme_classic() +
  scale_y_log10(
   limits = c(10^0, 10^6),
   breaks = scales::trans_breaks("log10", function(x) 10^x),
   labels = scales::trans_format("log10", scales::math_format(10^.x)), expand = c(0,0)) +
theme(axis.text.y = element_text(size=12), 
      axis.text.x = element_text(size=12), 
      axis.title.y = element_text(size=15, face="bold", angle = 0, vjust=0.5), 
      axis.title.x = element_text(size=15, face="bold"), 
      plot.margin = unit(c(0.5,0.5,0.5,0.5), "cm")) + 
ylab("Raw\nRead\nCount\n") +
xlab("\nSample Type") + 
geom_hline(yintercept = 150, linetype = "dashed", alpha = 0.5)
#dev.off()


```

```{r summary of raw read counts}

sum(raw_reads_by_sample$Total_Reads)
mean(raw_reads_by_sample$Total_Reads)
sd(raw_reads_by_sample$Total_Reads)
min(raw_reads_by_sample$Total_Reads)
max(raw_reads_by_sample$Total_Reads)

```

```{r quality checks, include = FALSE}

#display samples with less than 100 reads in a table
samples_below_150_read_threshold <- dplyr::filter(otu_df_plot_reads, Total_Reads <= 150) %>% 
                                    dplyr::select(Sample, Organ, Total_Reads)

kable(samples_below_150_read_threshold)

#create vector to filter samples with low read counts out 
samples.to.exclude <- samples_below_150_read_threshold$Sample %>% as.vector()

#QC step - remove samples which have less than 100 reads from dataframes used in main analysis
 otu_df <- dplyr::filter(otu_df, !(Sample %in% samples.to.exclude))
 otu_good <- dplyr::filter(otu_good, !(rownames(otu_good) %in% samples.to.exclude))

```

```{r plot raw read count versus ddpcr bacterial load}

dplyr::filter(otu_df, Organ == "Lung") %>%
ggplot(aes(x=log10(Total_Reads), y=log10(Gene_16S_copies_per_specimen), color = Sample_Type)) +
geom_point()

pdf(file="RevResp_Fig1.pdf", height=6, width=8, useDingbats = FALSE)
dplyr::filter(otu_df, !is.na(Gene_16S_copies_per_specimen)) %>%
ggplot(aes(y=log10(Total_Reads), x=log10(Gene_16S_copies_per_specimen), color = Sample_Type2)) +
geom_point() + 
  scale_x_continuous(limits = c(0, 5.1)) +
  scale_y_continuous(limits = c(0, 5)) + 
  theme_bw()
dev.off()
  

# cor(log10(otu_df$Total_Reads), log10(otu_df$Gene_16S_copies_per_specimen),  method = "pearson", use = "complete.obs")
```

\newpage
# III. Principal Component Analysis
## 3.1 Lung Samples vs. Sampling Controls

```{r Lung_Samples_v_Sampling_Controls}
#extract samples of interest with specified strings - returns vector of strings and NAs
extract.lungsamp.sampctrls <- str_extract(rownames(otu_good), pattern="_BAL_|_Lung_|PBS|CLEAN|USED|Homog")

#select subsets based on extracted samp names - returns a logical vector (NA --> FALSE)
extract.lungsamp.sampctrls.good <- !is.na(extract.lungsamp.sampctrls)

#subset otu counts 
otu.good.lungsamp.sampctrls <- otu_good[extract.lungsamp.sampctrls.good, ] 

#subset otu.df for PCA
otu.df.lungsamp.sampctrls <- filter(otu_df, Sample_Type == "BAL" | Sample_Type == "Lung" | Sample_Type == "PBS" | Sample_Type == "Clean_Rinse" | Sample_Type == "Used_Rinse" | Sample_Type == "Homog_Ctrl")

#make a hellinger normalized df and pca object from the normalized df 
make_hel_pca(otu.good.lungsamp.sampctrls)

# summarize pca object to allow for pulling the coordinates in the PC space
lungsamp_sampctrls_pca_summary <- summary(otu.good.lungsamp.sampctrls_pca) 

# select PC1 and PC2 to plot
#"sites" refers to each individual sample, i.e. ecologic sites 
pc_space <- lungsamp_sampctrls_pca_summary$sites %>% as.data.frame() %>% rownames_to_column() %>% dplyr::select(1:3) 
colnames(pc_space) <- c("Sample_Name", "PC1", "PC2")
                    
pc_loadings <- lungsamp_sampctrls_pca_summary$species # species as loading vectors

# attach your data from the pca object to your labels
centroid_df <- data.frame(Sample_Name = pc_space$Sample_Name, Sample_Type2 = otu.df.lungsamp.sampctrls[,"Sample_Type2"], PC1 = pc_space$PC1, PC2 = pc_space$PC2) 

# calculate the mean x coordinate and y coordinate for each sample in PC1/PC2 space
centroids <- centroid_df %>% 
  group_by(Sample_Type2) %>%
  summarize(x_coord=mean(PC1), y_coord=mean(PC2)) %>%  
  ungroup()

# to EACH SUBJECT in the pc object, add a column which contains the x and y
#coordinates for the centroid for the group that the subject belongs to
pc_plot_data <- full_join(centroid_df, centroids, by ="Sample_Type2") 
# Now you can use your dataframe and mainpulate it how you want

pc_plot_data$Sample_Type2 <- factor(pc_plot_data$Sample_Type2, 
                                     levels = c("Lung", "BAL", "PBS", "Syringe_Rinse",  "Homog_Ctrl"),
                                     labels = c("Lung", "BAL", "Saline", "Syringe Rinse",  "Homogenization\nControl"))

pca_pal <- c( "#EB3D0E", #scarlet - lung
               "#0300A6", # blue - BAL
              "#666B6E", #- saline
              "#9A99E9", #- used rinse
             "#F2C121" # saffron - water
        )

# plot PCA 
#pdf("Figure_5A.pdf", width=6, height=6, useDingbats = FALSE)
ggplot(pc_plot_data, aes(x = PC1, y = PC2)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_segment(aes(x=x_coord, xend = PC1, y=y_coord, yend = PC2), color = "black") + 
  geom_point(show.legend = FALSE, aes(color = Sample_Type2), size = 3) +
  # segment starting at centroid, ending at point
geom_label(aes(x=x_coord, y=y_coord, label=Sample_Type2, color=Sample_Type2), size=3, show.legend = FALSE) + # centroid information
  theme_classic() +
  theme(legend.title = element_blank(), 
      axis.text.y = element_text(size=15), 
      axis.text.x = element_text(size=15), 
      axis.title.y = element_text(size=12, face="bold", vjust = 0), 
      axis.title.x = element_text(size=12, face="bold", vjust = 0), 
      plot.margin = unit(c(0.5,0.5,0.5,0.5), "cm")
            ) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, 0.5)) +
  scale_y_continuous(limits = c(-1.1, 1.1), breaks = seq(-1,1,0.5)) +
  labs(
    x = "\nPrincipal Component 1 (15.1% explained)",
    y = "Principal Component 2  (7.0% explained)\n"
  ) + scale_color_manual(values=pca_pal)
#dev.off()

```


```{r PCA - Lung Samples vs. Sampling Controls - hypothesis testing}

#prepare hellinger-transformed df to be filtered for pairwise comparisons
adonis.select.vec <- dplyr::select(otu.df.lungsamp.sampctrls, Sample:Sample_Type)
adonis.hel.df <- rownames_to_column(otu.good.lungsamp.sampctrls_hel, var = "Sample")
adonis.hel.df <- left_join(adonis.hel.df, adonis.select.vec, by = "Sample") %>% 
                  dplyr::select(Sample, Sample_Type, everything())

#multiple comparisons - whole lung v. BAL v. pooled sampling controls 
adonis.hel.df.wbn <- column_to_rownames(adonis.hel.df, var = "Sample") %>% 
                      dplyr::select(-Sample_Type)
adonis(adonis.hel.df.wbn~otu.df.lungsamp.sampctrls$RA_Groups, method="euclidean", permutations=10000)

#pairwise comparisons - whole lung v. bal
adonis.hel.bl <- dplyr::filter(adonis.hel.df, Sample_Type == "Lung" | Sample_Type == "BAL") %>%
                  column_to_rownames(var = "Sample") %>% 
                  dplyr::select(-Sample_Type)
adonis.otudf.bl <- dplyr::filter(otu.df.lungsamp.sampctrls, 
                    Sample_Type == "Lung" | Sample_Type == "BAL")
adonis(adonis.hel.bl~adonis.otudf.bl$Sample_Type, method="euclidean", permutations=10000)

#pairwise comparison - whole lung v. sampling negative controls 
adonis.hel.wn <- dplyr::filter(adonis.hel.df, Sample_Type != "BAL") %>% 
                  column_to_rownames(var = "Sample") %>% 
                  dplyr::select(-Sample_Type)
adonis.otudf.wn <- dplyr::filter(otu.df.lungsamp.sampctrls, Sample_Type != "BAL")
adonis(adonis.hel.wn~adonis.otudf.wn$RA_Groups, method="euclidean", permutations=10000)

#pairwise comparison - BAL v. sampling negative controls 
adonis.hel.bn <- dplyr::filter(adonis.hel.df, Sample_Type != "Lung") %>% 
                  column_to_rownames(var = "Sample") %>%
                  dplyr::select(-Sample_Type)
adonis.otudf.bn <- dplyr::filter(otu.df.lungsamp.sampctrls, Sample_Type != "Lung")
adonis(adonis.hel.bn~adonis.otudf.bn$Organ, method="euclidean", permutations=10000)

```
\newpage
## 3.2 Lung Samples v. Isolation Controls 
```{r PCA_Lung_Samples_v_Isolation_Controls}
#extract samples of interest with specified strings - returns vector of strings and NAs
extract.lungsamp.isoctrls <- str_extract(rownames(otu_good), pattern="_BAL_|_Lung_|_IsoCtrl_|AE")

#select subsets based on extracted samp names - returns a logical vector (NA --> FALSE)
extract.lungsamp.isoctrls.good <- !is.na(extract.lungsamp.isoctrls)

#subset otu counts 
otu.good.lungsamp.isoctrls <- otu_good[extract.lungsamp.isoctrls.good, ] 

#subset otu.df for PCA
otu.df.lungsamp.isoctrls <- filter(otu_df, Sample_Type == "BAL" | Sample_Type == "Lung" | Sample_Type == "Iso_Ctrl" | Sample_Type == "AE")

#make a hellinger normalized df and pca object from the normalized df 
make_hel_pca(otu.good.lungsamp.isoctrls)

# summarize pca object to allow for pulling the coordinates in the PC space
lungsamp_isoctrls_pca_summary <- summary(otu.good.lungsamp.isoctrls_pca) 

# select PC1 and PC2 to plot
#"sites" refers to each individual sample, i.e. ecologic sites 
pc_space <- lungsamp_isoctrls_pca_summary$sites %>% as.data.frame() %>% rownames_to_column() %>% dplyr::select(1:3)
colnames(pc_space) <- c("Sample_Name", "PC1", "PC2")
                    
pc_loadings <- lungsamp_isoctrls_pca_summary$species  # species as loading vectors 

# attach your data from the pca object to your labels
centroid_df <- data.frame(Sample_Name = pc_space$Sample_Name, Sample_Type2 = otu.df.lungsamp.isoctrls[,"Sample_Type2"], PC1 = pc_space$PC1, PC2 = pc_space$PC2) 

# calculate the mean x coordinate and y coordinate for each sample in PC1/PC2 space
centroids <- centroid_df %>% 
  group_by(Sample_Type2) %>%
  summarize(x_coord=mean(PC1), y_coord=mean(PC2)) %>%  
  ungroup()

# to EACH SUBJECT in the pc object, add a column which contains the x and y
#coordinates for the centroid for the group that the subject belongs to
pc_plot_data <- full_join(centroid_df, centroids, by ="Sample_Type2") 
# Now you can use your dataframe and mainpulate it how you want

pc_plot_data$Sample_Type2 <- factor(pc_plot_data$Sample_Type2, 
                                     levels = c("Lung", "BAL", "AE", "Iso_Ctrl"), 
                                     labels = c("Lung", "BAL", "Elution\nBuffer", "Isolation\nControl"))


pca_pal <- c( "#EB3D0E", #scarlet - lung
               "#0300A6", # blue - BAL
              "#DBE6EC", #- AE
              "#666B6E" #- iso ctrl
        )

# plot PCA
pdf("Figure_S3A.pdf", height=6, width=6, useDingbats = FALSE)
ggplot(pc_plot_data, aes(x = PC1, y = PC2)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_segment(aes(x=x_coord, xend = PC1, y=y_coord, yend = PC2), color = "black") + 
  geom_point(show.legend = FALSE, aes(color = Sample_Type2), size = 3) +
  # segment starting at centroid, ending at point
geom_label(aes(x=x_coord, y=y_coord, label=Sample_Type2, color=Sample_Type2), size=3, show.legend = FALSE) + # centroid information
  theme_classic() +
  theme(legend.title = element_blank(), 
      axis.text.y = element_text(size=15), 
      axis.text.x = element_text(size=15), 
      axis.title.y = element_text(size=12, face="bold", vjust = 0), 
      axis.title.x = element_text(size=12, face="bold", vjust = 0), 
      plot.margin = unit(c(0.5,0.5,0.5,0.5), "cm")
            ) + 
  scale_color_manual(values = pca_pal) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, 0.5)) +
  scale_y_continuous(limits = c(-1, 1.5), breaks = seq(-1,1.5,0.5)) +
  labs(
    x = "\nPrincipal Component 1 (13.6% explained)",
    y = "Principal Component 2  (9.5% explained)\n"
  ) 
dev.off()

```

```{r Lung Samples vs. Isolation Controls - hypothesis testing}
#prepare hellinger-transformed df to be filtered for pairwise comparisons
adonis.select.vec <- dplyr::select(otu.df.lungsamp.isoctrls, Sample:Sample_Type)
adonis.hel.df <- rownames_to_column(otu.good.lungsamp.isoctrls_hel, var = "Sample")
adonis.hel.df <- left_join(adonis.hel.df, adonis.select.vec, by = "Sample") %>% 
                  dplyr::select(Sample, Sample_Type, everything())

#multiple comparisons - whole lung v. BAL v. pooled isolation controls
adonis(otu.good.lungsamp.isoctrls_hel~otu.df.lungsamp.isoctrls$Sample_Type, 
       method="euclidean", permutations=10000)

#pairwise comparison - whole lung v. iso ctrls 
adonis.hel.il <- dplyr::filter(adonis.hel.df, Sample_Type != "BAL") %>% 
                  column_to_rownames(var = "Sample") %>% dplyr::select(-Sample_Type)
adonis.otudf.il <- dplyr::filter(otu.df.lungsamp.isoctrls, Sample_Type != "BAL")
adonis(adonis.hel.il~adonis.otudf.il$RA_Groups, method="euclidean", permutations=10000)

#pairwise comparison - BAL v. iso ctrls
adonis.hel.ib <- dplyr::filter(adonis.hel.df, Sample_Type != "Lung") %>% 
                  column_to_rownames(var = "Sample") %>% dplyr::select(-Sample_Type)
adonis.otudf.ib <- dplyr::filter(otu.df.lungsamp.isoctrls, Sample_Type != "Lung")
adonis(adonis.hel.ib~adonis.otudf.ib$RA_Groups, method="euclidean", permutations=10000)

```
\newpage
## 3.3 Lung Samples vs. Sequencing Controls 
```{r PCA_Lung_Samples_v_Sequencing_Controls}

#extract samples of interest with specified strings - returns vector of strings and NAs
extract.lungsamp.seqctrls <- str_extract(rownames(otu_good), pattern="_BAL_|_Lung_|Water|Blank")

#select subsets based on extracted samp names - returns a logical vector (NA --> FALSE)
extract.lungsamp.seqctrls.good <- !is.na(extract.lungsamp.seqctrls)

#subset otu counts 
otu.good.lungsamp.seqctrls <- otu_good[extract.lungsamp.seqctrls.good, ] 

#subset otu.df for PCA
otu.df.lungsamp.seqctrls <- filter(otu_df, Sample_Type == "BAL" | Sample_Type == "Lung" | Sample_Type == "Water" | Sample_Type == "Empty")

#make a hellinger normalized df and pca object from the normalized df 
make_hel_pca(otu.good.lungsamp.seqctrls)

# summarize pca object to allow for pulling the coordinates in the PC space
lungsamp_seqctrls_pca_summary <- summary(otu.good.lungsamp.seqctrls_pca) 

# select PC1 and PC2 to plot
#"sites" refers to each individual sample, i.e. ecologic sites 
pc_space <- lungsamp_seqctrls_pca_summary$sites %>% as.data.frame() %>% rownames_to_column() %>% dplyr::select(1:3)
colnames(pc_space) <- c("Sample_Name", "PC1", "PC2")
                    
pc_loadings <- lungsamp_seqctrls_pca_summary$species # species as loading vectors

# attach your data from the pca object to your labels
centroid_df <- data.frame(Sample_Name = pc_space$Sample_Name, Sample_Type2 = otu.df.lungsamp.seqctrls[,"Sample_Type2"], PC1 = pc_space$PC1, PC2 = pc_space$PC2) 

# calculate the mean x coordinate and y coordinate for each sample in PC1/PC2 space
centroids <- centroid_df %>% 
  group_by(Sample_Type2) %>%
  summarize(x_coord=mean(PC1), y_coord=mean(PC2)) %>%  
  ungroup()

# to EACH SUBJECT in the pc object, add a column which contains the x and y
#coordinates for the centroid for the group that the subject belongs to
pc_plot_data <- full_join(centroid_df, centroids, by ="Sample_Type2") 
# Now you can use your dataframe and mainpulate it how you want

pc_plot_data$Sample_Type2 <- factor(pc_plot_data$Sample_Type2, 
                                     levels = c("Lung", "BAL", "Empty", "Water"), 
                                     labels = c("Lung", "BAL", "Empty\nWell", "Water"))


pca_pal <- c( "#EB3D0E", #scarlet - lung
               "#0300A6", # blue - BAL
              "#F2C121", #- Empty
              "#666B6E" #- Water
        )

pdf("Figure_S3B.pdf", height=6, width=6, useDingbats = FALSE)
ggplot(pc_plot_data, aes(x = PC1, y = PC2)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_segment(aes(x=x_coord, xend = PC1, y=y_coord, yend = PC2), color = "black") + 
  geom_point(show.legend = FALSE, aes(color = Sample_Type2), size = 3) +
  # segment starting at centroid, ending at point
#geom_label(aes(x=x_coord, y=y_coord, label=Sample_Type2, color=Sample_Type2), size=3, show.legend = FALSE) + # centroid information
  theme_classic() +
  theme(legend.title = element_blank(), 
      axis.text.y = element_text(size=15), 
      axis.text.x = element_text(size=15), 
      axis.title.y = element_text(size=12, face="bold", vjust = 0), 
      axis.title.x = element_text(size=12, face="bold", vjust = 0), 
      plot.margin = unit(c(0.5,0.5,0.5,0.5), "cm")
            ) + 
  scale_color_manual(values = pca_pal) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, 0.5)) +
  scale_y_continuous(limits = c(-1, 1), breaks = seq(-1,1,0.5)) +
  labs(
    x = "\nPrincipal Component 1 (15.3% explained)",
    y = "Principal Component 2  (8.0% explained)\n"
  ) 
dev.off()

```

```{r PCA Lung Samples vs. Sequencing Controls - hypothesis testing}
#prepare hellinger-transformed df to be filtered for pairwise comparisons
adonis.select.vec <- dplyr::select(otu.df.lungsamp.seqctrls, Sample:Sample_Type)
adonis.hel.df <- rownames_to_column(otu.good.lungsamp.seqctrls_hel, var = "Sample")
adonis.hel.df <- left_join(adonis.hel.df, adonis.select.vec, by = "Sample") %>% 
                  dplyr::select(Sample, Sample_Type, everything())

#multiple comparisons - whole lung v. BAL v. pooled sequencing controls
adonis(otu.good.lungsamp.seqctrls_hel~otu.df.lungsamp.seqctrls$Sample_Type, 
      method="euclidean", 
      permutations=10000)

#pairwise comparison - whole lung v. seq ctrls 
adonis.hel.sl <- dplyr::filter(adonis.hel.df, Sample_Type != "BAL") %>% 
                  column_to_rownames(var = "Sample") %>% 
                  dplyr::select(-Sample_Type)
adonis.otudf.sl <- dplyr::filter(otu.df.lungsamp.seqctrls, Sample_Type != "BAL")
adonis(adonis.hel.sl~adonis.otudf.sl$RA_Groups, method="euclidean", permutations=10000)

#pairwise comparison - BAL v. seq ctrls
adonis.hel.sb <- dplyr::filter(adonis.hel.df, Sample_Type != "Lung") %>% 
                  column_to_rownames(var = "Sample") %>% 
                  dplyr::select(-Sample_Type)
adonis.otudf.sb <- dplyr::filter(otu.df.lungsamp.seqctrls, Sample_Type != "Lung")
adonis(adonis.hel.sb~adonis.otudf.sb$RA_Groups, method="euclidean", permutations=10000)

```

\newpage
## 3.4 Lung Samples vs. Tongue
```{r PCA_Lung_Samples_v_Tongue}

#extract samples of interest with specified strings - returns vector of strings and NAs
extract.tong.lungsamp <- str_extract(rownames(otu_good), pattern="Tong|_BAL_|_Lung_")

#select subsets based on extracted samp names - returns a logical vector (NA --> FALSE)
extract.tong.lungsamp.good <- !is.na(extract.tong.lungsamp)

#subset otu counts 
otu.good.tong.lungsamp <- otu_good[extract.tong.lungsamp.good, ] 

#subset otu.df for PCA
otu.df.tong.lungsamp <- filter(otu_df, Sample_Type == "Tongue" | Sample_Type == "BAL" | Sample_Type == "Lung")

otu.df.tong.lungsamp <- mutate(otu.df.tong.lungsamp, PCA_Groups = ifelse(
                                          test = Organ == "Lung",             
                                          yes =  as.character(RA_Groups), 
                                          no = as.character(Organ))) %>% 
 dplyr::select(Sample:Gene_16S_copies_per_specimen, PCA_Groups, everything())
 

otu.df.tong.lungsamp$PCA_Groups <- as.factor(otu.df.tong.lungsamp$PCA_Groups)

#make a hellinger normalized df and pca object from the normalized df 
make_hel_pca(otu.good.tong.lungsamp)

tong_lungsamp_pca_summary <- summary(otu.good.tong.lungsamp_pca) # summarize pca object to allow for pulling the coordinates in the PC space

# select PC1 and PC2 for plotting
#"sites" refers to each individual sample, i.e. ecologic sites 
pc_space <- tong_lungsamp_pca_summary$sites %>% as.data.frame() %>% rownames_to_column() %>% dplyr::select(1:3)
colnames(pc_space) <- c("Sample_Name", "PC1", "PC2")
                    
pc_loadings <- tong_lungsamp_pca_summary$species # species as loading vectors 

# attach your data from the pca object to your labels
centroid_df <- data.frame(Sample_Name = pc_space$Sample_Name, PCA_Groups = otu.df.tong.lungsamp[,"PCA_Groups"], PC1 = pc_space$PC1, PC2 = pc_space$PC2) 

# calculate the mean x coordinate and y coordinate for each sample in PC1/PC2 space
centroids <- centroid_df %>% 
  group_by(PCA_Groups) %>%
  summarize(x_coord=mean(PC1), y_coord=mean(PC2)) %>%  
  ungroup()

# to EACH SUBJECT in the pc object, add a column which contains the x and y
#coordinates for the centroid for the group that the subject belongs to
pc_plot_data <- full_join(centroid_df, centroids, by ="PCA_Groups") 
# Now you can use your dataframe and mainpulate it how you want

pc_plot_data$PCA_Groups <- factor(pc_plot_data$PCA_Groups, 
                              levels = c("Lung", "BAL", "Tongue"))
                                    

pca_pal <- c( "#EB3D0E", #scarlet - lung
               "#0300A6", # blue - BAL
              "#FB9986" #vivid tangerine - tongue
        )

#pdf("Figure_5B.pdf", height=6, width=6, useDingbats = FALSE)
ggplot(pc_plot_data, aes(x = PC1, y = PC2)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_segment(aes(x=x_coord, xend = PC1, y=y_coord, yend = PC2), color = "black") + 
  geom_point(show.legend = FALSE, aes(color = PCA_Groups), size = 3) +
  # segment starting at centroid, ending at point
geom_label(aes(x=x_coord, y=y_coord, label=PCA_Groups, color=PCA_Groups), size=3, show.legend = FALSE) + # centroid information
  theme_classic() +
  theme(legend.title = element_blank(), 
      axis.text.y = element_text(size=15), 
      axis.text.x = element_text(size=15), 
      axis.title.y = element_text(size=12, face="bold", vjust = 0), 
      axis.title.x = element_text(size=12, face="bold", vjust = 0), 
      plot.margin = unit(c(0.5,0.5,0.5,0.5), "cm")
            ) + 
  scale_color_manual(values = pca_pal) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, 0.5)) +
  scale_y_continuous(limits = c(-1.1, 1.1), breaks = seq(-1,1,0.5)) +
  labs(
    x = "\nPrincipal Component 1 (12.8% explained)",
    y = "Principal Component 2  (5.6% explained)\n"
  ) 
#dev.off()

```


```{r PCA Lung Samples vs. Tongue - hypothesis testing}

#multiple comparisons - whole lung v. BAL v. tongue
adonis(otu.good.tong.lungsamp_hel~otu.df.tong.lungsamp$Sample_Type, 
       method="euclidean", 
       permutations=10000)

#prepare hellinger-transformed df to be filtered for pairwise comparisons
adonis.select.vec <- dplyr::select(otu.df.tong.lungsamp, Sample:Sample_Type)
adonis.hel.df <- rownames_to_column(otu.good.tong.lungsamp_hel, var = "Sample")
adonis.hel.df <- left_join(adonis.hel.df, adonis.select.vec, by = "Sample") %>% 
                  dplyr::select(Sample, Sample_Type, everything())

#pairwise comparison - whole lung v. tongue
adonis.hel.tl <- dplyr::filter(adonis.hel.df, Sample_Type == "Lung" | Sample_Type == "Tongue") %>%
                  column_to_rownames(var = "Sample") %>% 
                  dplyr::select(-Sample_Type)
adonis.otudf.tl <- dplyr::filter(otu.df.tong.lungsamp, 
                    Sample_Type == "Lung" | Sample_Type == "Tongue")
adonis(adonis.hel.tl~adonis.otudf.tl$Sample_Type, method="euclidean", permutations=10000)

#pairwise comparison - BAL v. tongue
adonis.hel.tb <- dplyr::filter(adonis.hel.df, Sample_Type == "BAL" | Sample_Type == "Tongue") %>%
                  column_to_rownames(var = "Sample") %>% 
                  dplyr::select(-Sample_Type)
adonis.otudf.tb <- dplyr::filter(otu.df.tong.lungsamp, Sample_Type == "BAL" | Sample_Type == "Tongue")
adonis(adonis.hel.tb~adonis.otudf.tb$Sample_Type, method="euclidean", permutations=10000)

```

\newpage 
## 3.5 Lung vs. Tongue vs. Negative Controls
```{r PCA_Lung_Samples_v_Tongue_v_Neg_Ctrls}

#extract samples of interest with specified strings - returns vector of strings and NAs
extract.tong.lungsamp.allnegctrls <- str_extract(rownames(otu_good), pattern="Tong|_BAL_|_Lung_|PBS|CLEAN|USED|Homog|AE|Iso|Water|Blank")

#select subsets based on extracted samp names - returns a logical vector (NA --> FALSE)
extract.tong.lungsamp.allnegctrls.good <- !is.na(extract.tong.lungsamp.allnegctrls)

#subset otu counts 
otu.good.tong.lungsamp.allnegctrls <- otu_good[extract.tong.lungsamp.allnegctrls.good, ] 

#subset otu.df for PCA
otu.df.tong.lungsamp.allnegctrls <- filter(otu_df, Sample_Type == "Tongue" | Sample_Type == "BAL" | Sample_Type == "Lung" | Sample_Type == "PBS" | Sample_Type == "Clean_Rinse" | Sample_Type == "Used_Rinse" | Sample_Type == "Homog_Ctrl" | Sample_Type == "AE" | Sample_Type == "Iso_Ctrl" | Sample_Type == "Water" | Sample_Type == "Empty")

otu.df.tong.lungsamp.allnegctrls <- mutate(otu.df.tong.lungsamp.allnegctrls, PCA_Groups = ifelse(
                                          test = Organ == "Lung",             
                                          yes =  as.character(RA_Groups), 
                                          no = as.character(Organ))) %>% 
 dplyr::select(Sample:Gene_16S_copies_per_specimen, PCA_Groups, everything())

otu.df.tong.lungsamp.allnegctrls$PCA_Groups <- as.factor(otu.df.tong.lungsamp.allnegctrls$PCA_Groups)

#make a hellinger normalized df and pca object from the normalized df 
make_hel_pca(otu.good.tong.lungsamp.allnegctrls)

# summarize pca object to allow for pulling the coordinates in the PC space
tong_lungsamp_relevnegctrls_pca_summary <- summary(otu.good.tong.lungsamp.allnegctrls_pca) 

# select PC1 and PC2 for plotting
#"sites" refers to each individual sample, i.e. ecologic sites 
pc_space <- tong_lungsamp_relevnegctrls_pca_summary$sites %>% as.data.frame() %>% rownames_to_column() %>% dplyr::select(1:3)
colnames(pc_space) <- c("Sample_Name", "PC1", "PC2")
                    
pc_loadings <- tong_lungsamp_relevnegctrls_pca_summary$species # species as loading vectors

# attach your data from the pca object to your labels
centroid_df <- data.frame(Sample_Name = pc_space$Sample_Name, PCA_Groups = otu.df.tong.lungsamp.allnegctrls[,"PCA_Groups"], PC1 = pc_space$PC1, PC2 = pc_space$PC2) 

# calculate the mean x coordinate and y coordinate for each sample in PC1/PC2 space
centroids <- centroid_df %>% 
  group_by(PCA_Groups) %>%
  summarize(x_coord=mean(PC1), y_coord=mean(PC2)) %>%  
  ungroup()

# to EACH SUBJECT in the pc object, add a column which contains the x and y
#coordinates for the centroid for the group that the subject belongs to
pc_plot_data <- full_join(centroid_df, centroids, by ="PCA_Groups") 
# Now you can use your dataframe and mainpulate it how you want

pc_plot_data$PCA_Groups <- factor(pc_plot_data$PCA_Groups, 
                              levels = c("Lung", "BAL", "Tongue", "Sampling Control", "Isolation Control", "Sequencing Control"))
                                    

pca_pal <- c( "#EB3D0E", #scarlet - lung
               "#0300A6", # blue - BAL
              "#FB9986", #vivid tangerine - tongue
              "#0BDBA7", #sea foam green - sampling ctrls
              "#F2C121", #- isolation ctrls 
              "#666B6E" #- sequencing ctrls
        )

# plot PCA for all
ggplot(pc_plot_data, aes(x = PC1, y = PC2)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_segment(aes(x=x_coord, xend = PC1, y=y_coord, yend = PC2), color = "black") + 
  geom_point(show.legend = FALSE, aes(color = PCA_Groups), size = 2) +
  # segment starting at centroid, ending at point
geom_label(aes(x=x_coord, y=y_coord, label=PCA_Groups, color=PCA_Groups), size=3, show.legend = FALSE) + # centroid information
  theme_classic() +
  theme(legend.title = element_blank(), 
      axis.text.y = element_text(size=15), 
      axis.text.x = element_text(size=15), 
      axis.title.y = element_text(size=12, face="bold", vjust = 0), 
      axis.title.x = element_text(size=12, face="bold", vjust = 0), 
      plot.margin = unit(c(0.5,0.5,0.5,0.5), "cm")
            ) + 
  scale_color_manual(values = pca_pal) + 
  scale_x_continuous(limits = c(-0.75, 0.75), breaks =  c(-0.75, -0.5, -0.25, 0, 0.25, 0.5, 0.75)) +
  scale_y_continuous(limits = c(-0.75, 0.75), breaks = c(-0.75, -0.5, -0.25, 0, 0.25, 0.5, 0.75)) +
  labs(
    x = "\nPrincipal Component 1 (11.6% explained)",
    y = "Principal Component 2  (6.3% explained)\n"
  ) 

```
\newpage
# Supplemental Ordination Analyses: Principal Coordinate Analysis
## 3.6 PCoA - Lung Samples v. Sampling Controls

```{r PCoA - Lung Samples v. Sampling Controls - Percentage Normalized}

#subset otu.df for PCA
otu.df.lungsamp.sampctrls <- filter(otu_df, Sample_Type == "BAL" | Sample_Type == "Lung" | Sample_Type == "PBS" | Sample_Type == "Clean_Rinse" | Sample_Type == "Used_Rinse" | Sample_Type == "Homog_Ctrl")


bray_df_perc <- otu.df.lungsamp.sampctrls %>% 
  column_to_rownames("Sample")  %>% # This turns the specimen column into the rownames.
  dplyr::select(-c(Sample_Type:Gene_16S_copies_per_specimen))

# First step is to calculate a distance matrix. 
# Here we use Bray-Curtis distance metric
dist <- vegdist(bray_df_perc,  method = "bray")
PCOA <- pcoa(dist)

# Extract the plot scores from first two PCoA axes (if you need them):
PCOAaxes <- PCOA$vectors[,c(1,2)] %>% 
            as.data.frame() %>% 
            rownames_to_column("Sample")

pcoa_df <- left_join(PCOAaxes, otu.df.lungsamp.sampctrls)

# calculate the mean x coordinate and y coordinate for each sample in PC1/PC2 space
centroids <- pcoa_df %>% 
  group_by(Sample_Type2) %>%
  summarize(x_coord=mean(Axis.1), y_coord=mean(Axis.2)) %>%  
  ungroup()

# to EACH SUBJECT in the pc object, add a column which contains the x and y
#coordinates for the centroid for the group that the subject belongs to
pc_plot_data <- full_join(pcoa_df, centroids, by ="Sample_Type2") 
# Now you can use your dataframe and mainpulate it how you want

pc_plot_data$Sample_Type2 <- factor(pc_plot_data$Sample_Type2, 
                                     levels = c("Lung", "BAL", "PBS", "Syringe_Rinse",  "Homog_Ctrl"),
                                     labels = c("Lung", "BAL", "Saline", "Syringe Rinse",  "Homogenization\nControl"))

pca_pal <- c( "#EB3D0E", #scarlet - lung
               "#0300A6", # blue - BAL
              "#666B6E", #- saline
              "#9A99E9", #- used rinse
             "#F2C121" # saffron - water
        )

# plot PCA 
ggplot(pc_plot_data, aes(x = Axis.1, y = Axis.2)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_segment(aes(x=x_coord, xend = Axis.1, y=y_coord, yend = Axis.2), color = "black") + 
  geom_point(show.legend = FALSE, aes(color = Sample_Type2), size = 3) +
  # segment starting at centroid, ending at point
geom_label(aes(x=x_coord, y=y_coord, label=Sample_Type2, color=Sample_Type2), size=3, show.legend = FALSE) + # centroid information
  theme_classic() +
  theme(legend.title = element_blank(), 
      axis.text.y = element_text(size=15), 
      axis.text.x = element_text(size=15), 
      axis.title.y = element_text(size=12, face="bold", vjust = 0), 
      axis.title.x = element_text(size=12, face="bold", vjust = 0), 
      plot.margin = unit(c(0.5,0.5,0.5,0.5), "cm")
            ) + 
  scale_x_continuous(limits = c(-0.6, 0.6), breaks = seq(-0.5, 0.5, 0.5)) +
  scale_y_continuous(limits = c(-0.6, 0.6), breaks = seq(-0.5, 0.5, 0.5)) +
  labs(
    x = "\nAxis 1 (14.8% explained)",
    y = "Axis 2  (11.0% explained)\n"
  ) + scale_color_manual(values=pca_pal)
```
```{r PCoA - Lung Samples vs. Sampling Controls - hypothesis testing}
#subset otu.df 
otu.df.lungsamp.sampctrls <- filter(otu_df, Sample_Type == "BAL" | Sample_Type == "Lung" | Sample_Type == "PBS" | Sample_Type == "Clean_Rinse" | Sample_Type == "Used_Rinse" | Sample_Type == "Homog_Ctrl")

#remove metadata
bray_df_perc <- otu.df.lungsamp.sampctrls %>% 
  column_to_rownames("Sample")  %>% # This turns the specimen column into the rownames.
  dplyr::select(-c(Sample_Type:Gene_16S_copies_per_specimen))

#prepare df to be filtered for pairwise comparisons
adonis.select.vec <- dplyr::select(otu.df.lungsamp.sampctrls, Sample:Sample_Type)
adonis_bray_df <- bray_df_perc %>% 
                  rownames_to_column(var="Sample")
adonis_df <- left_join(adonis_bray_df, adonis.select.vec, by = "Sample") %>%
                  dplyr::select(Sample, Sample_Type, everything())

#don't need to calculate Bray-Curtis distance matrix bc adonis will do that for you
#adonis passes method and other arguments to vegdist() if you give it a percentage normalized count matrix
#easier to do it this way because distance matrices are difficult to filter
#see adonis function documentation for more

#multiple comparisons - whole lung v. BAL v. pooled sampling controls 
adonis(bray_df_perc~otu.df.lungsamp.sampctrls$RA_Groups, method="bray", permutations=10000)

#pairwise comparisons - whole lung v. bal
adonis.df.bl <- dplyr::filter(adonis_df, Sample_Type == "Lung" | Sample_Type == "BAL") %>%
                  column_to_rownames(var = "Sample") %>% 
                  dplyr::select(-Sample_Type)
adonis.otudf.bl <- dplyr::filter(otu.df.lungsamp.sampctrls, 
                    Sample_Type == "Lung" | Sample_Type == "BAL")
adonis(adonis.df.bl~adonis.otudf.bl$Sample_Type, method="bray", permutations=10000)

#pairwise comparison - whole lung v. sampling negative controls 
adonis.df.wn <- dplyr::filter(adonis_df, Sample_Type != "BAL") %>% 
                  column_to_rownames(var = "Sample") %>% 
                  dplyr::select(-Sample_Type)
adonis.otudf.wn <- dplyr::filter(otu.df.lungsamp.sampctrls, Sample_Type != "BAL")
adonis(adonis.df.wn~adonis.otudf.wn$RA_Groups, method="bray", permutations=10000)

#pairwise comparison - BAL v. sampling negative controls 
adonis.df.bn <- dplyr::filter(adonis_df, Sample_Type != "Lung") %>% 
                  column_to_rownames(var = "Sample") %>%
                  dplyr::select(-Sample_Type)
adonis.otudf.bn <- dplyr::filter(otu.df.lungsamp.sampctrls, Sample_Type != "Lung")
adonis(adonis.df.bn~adonis.otudf.bn$Organ, method="bray", permutations=10000)

```

## 3.7 PCoA - Lung Samples v. Isolation Controls
```{r PCoA - Lung Samples v. Isolation Controls - Percentage Normalized}
#subset otu.df for PCA
otu.df.lungsamp.isoctrls <- filter(otu_df, Sample_Type == "BAL" | Sample_Type == "Lung" | Sample_Type == "Iso_Ctrl" | Sample_Type == "AE")

bray_df_perc <- otu.df.lungsamp.isoctrls %>% 
  column_to_rownames("Sample")  %>% # This turns the specimen column into the rownames.
  dplyr::select(-c(Sample_Type:Gene_16S_copies_per_specimen))

# First step is to calculate a distance matrix. 
# Here we use Bray-Curtis distance metric
dist <- vegdist(bray_df_perc,  method = "bray")
PCOA <- pcoa(dist)

# Extract the plot scores from first two PCoA axes (if you need them):
PCOAaxes <- PCOA$vectors[,c(1,2)] %>% 
            as.data.frame() %>% 
            rownames_to_column("Sample")

pcoa_df <- left_join(PCOAaxes, otu.df.lungsamp.isoctrls)

# calculate the mean x coordinate and y coordinate for each sample in PC1/PC2 space
centroids <- pcoa_df %>% 
  group_by(Sample_Type2) %>%
  summarize(x_coord=mean(Axis.1), y_coord=mean(Axis.2)) %>%  
  ungroup()

# to EACH SUBJECT in the pc object, add a column which contains the x and y
#coordinates for the centroid for the group that the subject belongs to
pc_plot_data <- full_join(pcoa_df, centroids, by ="Sample_Type2") 
# Now you can use your dataframe and mainpulate it how you want

pc_plot_data$Sample_Type2 <- factor(pc_plot_data$Sample_Type2, 
                                     levels = c("Lung", "BAL", "AE", "Iso_Ctrl"), 
                                     labels = c("Lung", "BAL", "Elution\nBuffer", "Isolation\nControl"))


pca_pal <- c( "#EB3D0E", #scarlet - lung
               "#0300A6", # blue - BAL
              "#DBE6EC", #- AE
              "#666B6E" #- iso ctrl
        )

# plot PCA 
ggplot(pc_plot_data, aes(x = Axis.1, y = Axis.2)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_segment(aes(x=x_coord, xend = Axis.1, y=y_coord, yend = Axis.2), color = "black") + 
  geom_point(show.legend = FALSE, aes(color = Sample_Type2), size = 3) +
  # segment starting at centroid, ending at point
geom_label(aes(x=x_coord, y=y_coord, label=Sample_Type2, color=Sample_Type2), size=3, show.legend = FALSE) + # centroid information
  theme_classic() +
  theme(legend.title = element_blank(), 
      axis.text.y = element_text(size=15), 
      axis.text.x = element_text(size=15), 
      axis.title.y = element_text(size=12, face="bold", vjust = 0), 
      axis.title.x = element_text(size=12, face="bold", vjust = 0), 
      plot.margin = unit(c(0.5,0.5,0.5,0.5), "cm")
            ) + 
  scale_x_continuous(limits = c(-0.6, 0.6), breaks = seq(-0.5, 0.5, 0.5)) +
  scale_y_continuous(limits = c(-0.6, 0.6), breaks = seq(-0.5, 0.5, 0.5)) +
  labs(
    x = "\nAxis 1 (13.7% of variance explained)",
    y = "Axis 2  (10.2% of variance explained)\n"
  ) + scale_color_manual(values=pca_pal)
```

```{r PCoA Lung Samples vs. Isolation Controls - hypothesis testing}
#subset otu.df 
otu.df.lungsamp.isoctrls <- filter(otu_df, Sample_Type == "BAL" | Sample_Type == "Lung" | Sample_Type == "Iso_Ctrl" | Sample_Type == "AE")

#remove metadata
bray_df_perc <- otu.df.lungsamp.isoctrls %>% 
  column_to_rownames("Sample")  %>% # This turns the specimen column into the rownames.
  dplyr::select(-c(Sample_Type:Gene_16S_copies_per_specimen))

#prepare df to be filtered for pairwise comparisons
adonis.select.vec <- dplyr::select(otu.df.lungsamp.isoctrls, Sample:Sample_Type)
adonis_bray_df <- bray_df_perc %>% 
                  rownames_to_column(var="Sample")
adonis_df <- left_join(adonis_bray_df, adonis.select.vec, by = "Sample") %>%
                  dplyr::select(Sample, Sample_Type, everything())

#don't need to calculate Bray-Curtis distance matrix bc adonis will do that for you
#adonis passes method and other arguments to vegdist() if you give it a percentage normalized count matrix
#easier to do it this way because distance matrices are difficult to filter
#see adonis function documentation for more
#remove metadata

#multiple comparisons - whole lung v. BAL v. pooled isolation controls
adonis(bray_df_perc~otu.df.lungsamp.isoctrls$Sample_Type, 
       method="bray", permutations=10000)

#pairwise comparison - whole lung v. iso ctrls 
adonis.df.il <- dplyr::filter(adonis_df, Sample_Type != "BAL") %>% 
                  column_to_rownames(var = "Sample") %>% dplyr::select(-Sample_Type)
adonis.otudf.il <- dplyr::filter(otu.df.lungsamp.isoctrls, Sample_Type != "BAL")
adonis(adonis.df.il~adonis.otudf.il$RA_Groups, method="bray", permutations=10000)

#pairwise comparison - BAL v. iso ctrls
adonis.df.ib <- dplyr::filter(adonis_df, Sample_Type != "Lung") %>% 
                  column_to_rownames(var = "Sample") %>% dplyr::select(-Sample_Type)
adonis.otudf.ib <- dplyr::filter(otu.df.lungsamp.isoctrls, Sample_Type != "Lung")
adonis(adonis.df.ib~adonis.otudf.ib$RA_Groups, method="bray", permutations=10000)

```

## 3.8 PCoA - Lung Samples v. Sequencing Controls
```{r PCoA - Lung Samples v. Sequencing Controls - Percentage Normalized}

#subset otu.df for PCA
otu.df.lungsamp.seqctrls <- filter(otu_df, Sample_Type == "BAL" | Sample_Type == "Lung" | Sample_Type == "Water" | Sample_Type == "Empty")

bray_df_perc <- otu.df.lungsamp.seqctrls %>% 
  column_to_rownames("Sample")  %>% # This turns the specimen column into the rownames.
  dplyr::select(-c(Sample_Type:Gene_16S_copies_per_specimen))

# First step is to calculate a distance matrix. 
# Here we use Bray-Curtis distance metric
dist <- vegdist(bray_df_perc,  method = "bray")
PCOA <- pcoa(dist)

# Extract the plot scores from first two PCoA axes (if you need them):
PCOAaxes <- PCOA$vectors[,c(1,2)] %>% 
            as.data.frame() %>% 
            rownames_to_column("Sample")

pcoa_df <- left_join(PCOAaxes, otu.df.lungsamp.seqctrls)

# calculate the mean x coordinate and y coordinate for each sample in PC1/PC2 space
centroids <- pcoa_df %>% 
  group_by(Sample_Type2) %>%
  summarize(x_coord=mean(Axis.1), y_coord=mean(Axis.2)) %>%  
  ungroup()

# to EACH SUBJECT in the pc object, add a column which contains the x and y
#coordinates for the centroid for the group that the subject belongs to
pc_plot_data <- full_join(pcoa_df, centroids, by ="Sample_Type2") 
# Now you can use your dataframe and mainpulate it how you want

pc_plot_data$Sample_Type2 <- factor(pc_plot_data$Sample_Type2, 
                                     levels = c("Lung", "BAL", "Empty", "Water"), 
                                     labels = c("Lung", "BAL", "Empty\nWell", "Water"))


pca_pal <- c( "#EB3D0E", #scarlet - lung
               "#0300A6", # blue - BAL
              "#F2C121", #- Empty
              "#666B6E" #- Water
        )

# plot PCA 
ggplot(pc_plot_data, aes(x = Axis.1, y = Axis.2)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_segment(aes(x=x_coord, xend = Axis.1, y=y_coord, yend = Axis.2), color = "black") + 
  geom_point(show.legend = FALSE, aes(color = Sample_Type2), size = 3) +
  # segment starting at centroid, ending at point
geom_label(aes(x=x_coord, y=y_coord, label=Sample_Type2, color=Sample_Type2), size=3, show.legend = FALSE) + # centroid information
  theme_classic() +
  theme(legend.title = element_blank(), 
      axis.text.y = element_text(size=15), 
      axis.text.x = element_text(size=15), 
      axis.title.y = element_text(size=12, face="bold", vjust = 0), 
      axis.title.x = element_text(size=12, face="bold", vjust = 0), 
      plot.margin = unit(c(0.5,0.5,0.5,0.5), "cm")
            ) + 
  scale_x_continuous(limits = c(-0.6, 0.6), breaks = seq(-0.5, 0.5, 0.5)) +
  scale_y_continuous(limits = c(-0.6, 0.6), breaks = seq(-0.5, 0.5, 0.5)) +
  labs(
    x = "\nAxis 1 (14.8% of variance explained)",
    y = "Axis 2  (11.0% of variance explained)\n"
  ) + scale_color_manual(values=pca_pal)
```
```{r PCoA Lung Samples vs. Sequencing Controls - hypothesis testing}

#subset otu.df 
otu.df.lungsamp.seqctrls <- filter(otu_df, Sample_Type == "BAL" | Sample_Type == "Lung" | Sample_Type == "Water" | Sample_Type == "Empty")

#remove metadata
bray_df_perc <- otu.df.lungsamp.seqctrls %>% 
  column_to_rownames("Sample")  %>% # This turns the specimen column into the rownames.
  dplyr::select(-c(Sample_Type:Gene_16S_copies_per_specimen))


#prepare df to be filtered for pairwise comparisons
adonis.select.vec <- dplyr::select(otu.df.lungsamp.seqctrls, Sample:Sample_Type)
adonis_bray_df <- bray_df_perc %>% 
                  rownames_to_column(var="Sample")
adonis_df <- left_join(adonis_bray_df, adonis.select.vec, by = "Sample") %>%
                  dplyr::select(Sample, Sample_Type, everything())

#don't need to calculate Bray-Curtis distance matrix bc adonis will do that for you
#adonis passes method and other arguments to vegdist() if you give it a percentage normalized count matrix
#easier to do it this way because distance matrices are difficult to filter
#see adonis function documentation for more

#multiple comparisons - whole lung v. BAL v. pooled sequencing controls
adonis(bray_df_perc~otu.df.lungsamp.seqctrls$Sample_Type, method="bray", permutations=10000)

#pairwise comparison - whole lung v. seq ctrls 
adonis.df.sl <- dplyr::filter(adonis_df, Sample_Type != "BAL") %>% 
                  column_to_rownames(var = "Sample") %>% 
                  dplyr::select(-Sample_Type)
adonis.otudf.sl <- dplyr::filter(otu.df.lungsamp.seqctrls, Sample_Type != "BAL")
adonis(adonis.df.sl~adonis.otudf.sl$RA_Groups, method="bray", permutations=10000)

#pairwise comparison - BAL v. seq ctrls
adonis.df.sb <- dplyr::filter(adonis_df, Sample_Type != "Lung") %>% 
                  column_to_rownames(var = "Sample") %>% 
                  dplyr::select(-Sample_Type)
adonis.otudf.sb <- dplyr::filter(otu.df.lungsamp.seqctrls, Sample_Type != "Lung")
adonis(adonis.df.sb~adonis.otudf.sb$RA_Groups, method="bray", permutations=10000)

```


## 3.9 PCoA - Lung Samples v. Tongue 
```{r PCoA - Lung Samples v. Tongue - Percentage Normalized}

#subset otu.df for PCA
otu.df.tong.lungsamp <- filter(otu_df, Sample_Type == "Tongue" | Sample_Type == "BAL" | Sample_Type == "Lung")

otu.df.tong.lungsamp <- mutate(otu.df.tong.lungsamp, PCA_Groups = ifelse(
                                          test = Organ == "Lung",             
                                          yes =  as.character(RA_Groups), 
                                          no = as.character(Organ))) %>% 
 dplyr::select(Sample:Gene_16S_copies_per_specimen, PCA_Groups, everything())
 

otu.df.tong.lungsamp$PCA_Groups <- as.factor(otu.df.tong.lungsamp$PCA_Groups)

bray_df_perc <- otu.df.tong.lungsamp %>% 
  column_to_rownames("Sample")  %>% # This turns the specimen column into the rownames.
  dplyr::select(-c(Sample_Type:PCA_Groups))

# First step is to calculate a distance matrix. 
# Here we use Bray-Curtis distance metric
dist <- vegdist(bray_df_perc,  method = "bray")
PCOA <- pcoa(dist)

# Extract the plot scores from first two PCoA axes (if you need them):
PCOAaxes <- PCOA$vectors[,c(1,2)] %>% 
            as.data.frame() %>% 
            rownames_to_column("Sample")

pcoa_df <- left_join(PCOAaxes, otu.df.tong.lungsamp)

# calculate the mean x coordinate and y coordinate for each sample in PC1/PC2 space
centroids <- pcoa_df %>% 
  group_by(PCA_Groups) %>%
  summarize(x_coord=mean(Axis.1), y_coord=mean(Axis.2)) %>%  
  ungroup()

# to EACH SUBJECT in the pc object, add a column which contains the x and y
#coordinates for the centroid for the group that the subject belongs to
pc_plot_data <- full_join(pcoa_df, centroids, by ="PCA_Groups") 
# Now you can use your dataframe and mainpulate it how you want

pc_plot_data$PCA_Groups <- factor(pc_plot_data$PCA_Groups, 
                              levels = c("Lung", "BAL", "Tongue"))
                                    

pca_pal <- c( "#EB3D0E", #scarlet - lung
               "#0300A6", # blue - BAL
              "#FB9986" #vivid tangerine - tongue
        )

# plot PCA 
ggplot(pc_plot_data, aes(x = Axis.1, y = Axis.2)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_segment(aes(x=x_coord, xend = Axis.1, y=y_coord, yend = Axis.2), color = "black") + 
  geom_point(show.legend = FALSE, aes(color = PCA_Groups), size = 3) +
  # segment starting at centroid, ending at point
geom_label(aes(x=x_coord, y=y_coord, label=PCA_Groups, color=PCA_Groups), size=3, show.legend = FALSE) + # centroid information
  theme_classic() +
  theme(legend.title = element_blank(), 
      axis.text.y = element_text(size=15), 
      axis.text.x = element_text(size=15), 
      axis.title.y = element_text(size=12, face="bold", vjust = 0), 
      axis.title.x = element_text(size=12, face="bold", vjust = 0), 
      plot.margin = unit(c(0.5,0.5,0.5,0.5), "cm")
            ) + 
  scale_x_continuous(limits = c(-0.6, 0.6), breaks = seq(-0.5, 0.5, 0.5)) +
  scale_y_continuous(limits = c(-0.6, 0.6), breaks = seq(-0.5, 0.5, 0.5)) +
  labs(
    x = "\nAxis 1 (11.1% of variance explained)",
    y = "Axis 2  (8.5% of variance explained)\n"
  ) + scale_color_manual(values=pca_pal)
```
```{r PCoA Lung Samples vs. Tongue - hypothesis testing}
#subset otu.df 
otu.df.tong.lungsamp <- filter(otu_df, Sample_Type == "Tongue" | Sample_Type == "BAL" | Sample_Type == "Lung")

otu.df.tong.lungsamp <- mutate(otu.df.tong.lungsamp, PCA_Groups = ifelse(
                                          test = Organ == "Lung",             
                                          yes =  as.character(RA_Groups), 
                                          no = as.character(Organ))) %>% 
 dplyr::select(Sample:Gene_16S_copies_per_specimen, PCA_Groups, everything())
 

otu.df.tong.lungsamp$PCA_Groups <- as.factor(otu.df.tong.lungsamp$PCA_Groups)

#remove metadata
bray_df_perc <- otu.df.tong.lungsamp %>% 
  column_to_rownames("Sample")  %>% # This turns the specimen column into the rownames.
  dplyr::select(-c(Sample_Type:PCA_Groups))

#prepare df to be filtered for pairwise comparisons
adonis.select.vec <- dplyr::select(otu.df.tong.lungsamp, Sample:Sample_Type)
adonis_bray_df <- bray_df_perc %>% 
                  rownames_to_column(var="Sample")
adonis_df <- left_join(adonis_bray_df, adonis.select.vec, by = "Sample") %>%
                  dplyr::select(Sample, Sample_Type, everything())

#don't need to calculate Bray-Curtis distance matrix bc adonis will do that for you
#adonis passes method and other arguments to vegdist() if you give it a percentage normalized count matrix
#easier to do it this way because distance matrices are difficult to filter
#see adonis function documentation for more

#multiple comparisons - whole lung v. BAL v. tongue
adonis(bray_df_perc~otu.df.tong.lungsamp$Sample_Type, method="bray", permutations=10000)

#pairwise comparison - whole lung v. tongue
adonis.df.tl <- dplyr::filter(adonis_df, Sample_Type == "Lung" | Sample_Type == "Tongue") %>%
                  column_to_rownames(var = "Sample") %>% 
                  dplyr::select(-Sample_Type)
adonis.otudf.tl <- dplyr::filter(otu.df.tong.lungsamp, 
                    Sample_Type == "Lung" | Sample_Type == "Tongue")
adonis(adonis.df.tl~adonis.otudf.tl$Sample_Type, method="bray", permutations=10000)

#pairwise comparison - BAL v. tongue
adonis.df.tb <- dplyr::filter(adonis_df, Sample_Type == "BAL" | Sample_Type == "Tongue") %>%
                  column_to_rownames(var = "Sample") %>% 
                  dplyr::select(-Sample_Type)
adonis.otudf.tb <- dplyr::filter(otu.df.tong.lungsamp, Sample_Type == "BAL" | Sample_Type == "Tongue")
adonis(adonis.df.tb~adonis.otudf.tb$Sample_Type, method="bray", permutations=10000)

```

## 3.10 PCoA - Lung v. Negative Controls

```{r PCoA - Lung Samples v. Negative Controls - Percentage Normalized}

#subset otu.df for PCA
otu.df.tong.lungsamp.allnegctrls <- filter(otu_df, Sample_Type == "Tongue" | Sample_Type == "BAL" | Sample_Type == "Lung" | Sample_Type == "PBS" | Sample_Type == "Clean_Rinse" | Sample_Type == "Used_Rinse" | Sample_Type == "Homog_Ctrl" | Sample_Type == "AE" | Sample_Type == "Iso_Ctrl" | Sample_Type == "Water" | Sample_Type == "Empty")

otu.df.tong.lungsamp.allnegctrls <- mutate(otu.df.tong.lungsamp.allnegctrls, PCA_Groups = ifelse(
                                          test = Organ == "Lung",             
                                          yes =  as.character(RA_Groups), 
                                          no = as.character(Organ))) %>% 
 dplyr::select(Sample:Gene_16S_copies_per_specimen, PCA_Groups, everything())

otu.df.tong.lungsamp.allnegctrls$PCA_Groups <- as.factor(otu.df.tong.lungsamp.allnegctrls$PCA_Groups)

bray_df_perc <- otu.df.tong.lungsamp.allnegctrls %>% 
  column_to_rownames("Sample")  %>% # This turns the specimen column into the rownames.
  dplyr::select(-c(Sample_Type:PCA_Groups))

# First step is to calculate a distance matrix. 
# Here we use Bray-Curtis distance metric
dist <- vegdist(bray_df_perc,  method = "bray")
PCOA <- pcoa(dist)

# Extract the plot scores from first two PCoA axes (if you need them):
PCOAaxes <- PCOA$vectors[,c(1,2)] %>% 
            as.data.frame() %>% 
            rownames_to_column("Sample")

pcoa_df <- left_join(PCOAaxes, otu.df.tong.lungsamp.allnegctrls)

# calculate the mean x coordinate and y coordinate for each sample in PC1/PC2 space
centroids <- pcoa_df %>% 
  group_by(PCA_Groups) %>%
  summarize(x_coord=mean(Axis.1), y_coord=mean(Axis.2)) %>%  
  ungroup()

# to EACH SUBJECT in the pc object, add a column which contains the x and y
#coordinates for the centroid for the group that the subject belongs to
pc_plot_data <- full_join(pcoa_df, centroids, by ="PCA_Groups") 
# Now you can use your dataframe and mainpulate it how you want

pc_plot_data$PCA_Groups <- factor(pc_plot_data$PCA_Groups, 
                              levels = c("Lung", "BAL", "Tongue", "Sampling Control", "Isolation Control", "Sequencing Control"))
                                    

pca_pal <- c( "#EB3D0E", #scarlet - lung
               "#0300A6", # blue - BAL
              "#FB9986", #vivid tangerine - tongue
              "#0BDBA7", #sea foam green - sampling ctrls
              "#F2C121", #- isolation ctrls 
              "#666B6E" #- sequencing ctrls
        )

# plot PCA 
ggplot(pc_plot_data, aes(x = Axis.1, y = Axis.2)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) + 
  geom_segment(aes(x=x_coord, xend = Axis.1, y=y_coord, yend = Axis.2), color = "black") + 
  geom_point(show.legend = FALSE, aes(color = PCA_Groups), size = 3) +
  # segment starting at centroid, ending at point
geom_label(aes(x=x_coord, y=y_coord, label=PCA_Groups, color=PCA_Groups), size=3, show.legend = FALSE) + # centroid information
  theme_classic() +
  theme(legend.title = element_blank(), 
      axis.text.y = element_text(size=15), 
      axis.text.x = element_text(size=15), 
      axis.title.y = element_text(size=12, face="bold", vjust = 0), 
      axis.title.x = element_text(size=12, face="bold", vjust = 0), 
      plot.margin = unit(c(0.5,0.5,0.5,0.5), "cm")
            ) + 
  scale_x_continuous(limits = c(-0.6, 0.6), breaks = seq(-0.5, 0.5, 0.5)) +
  scale_y_continuous(limits = c(-0.6, 0.6), breaks = seq(-0.5, 0.5, 0.5)) +
  labs(
    x = "\nAxis 1 (5.5% of variance explained)",
    y = "Axis 2  (4.4% of variance explained)\n"
  ) + scale_color_manual(values=pca_pal)
```
\newpage
# IV. Diversity Indices 
## 4.1 Alpha Diversity - Rarified Richness 

```{r rarefaction mean curve by type}

#Rarefaction curves can also be used to explore -diversity. First, the data needs to be prepared. 
#clean up raw count table
otu_raw_rare <- otu_raw
rownames(otu_raw_rare) <-  str_remove(string = rownames(otu_raw_rare), pattern = "_S\\d+_L001_R1_001") %>% str_remove(pattern = "_S\\d+_L001_R1") 
otu_raw_rare <- dplyr::select(otu_raw_rare, -label, -numOtus)

#exclude samples with low read count from analysis
otu_raw_rare <- dplyr::filter(otu_raw_rare, !(rownames(otu_raw_rare) %in% samples.to.exclude))



# Generate the rarefaction data, combine with metadata, transform for plotting, and aggregate
rarefy_agg <- rarefy(otu_raw_rare, sample = 1:1000) %>% # subsample for each number in 1:1000; an alternative is to set sample = to the integer length of primary interest, e.g. 1000
  data.frame(row.names = rownames(otu_raw_rare)) %>% # Use cleaned up rownames from otu_good rather than messy names from otu_raw
  rownames_to_column("Sample") %>%
  pivot_longer(-Sample, names_to = "Sample_Seq_Num", names_prefix = "N", values_to = "Unique_Species") %>% # Transform data from long to wide format
  left_join(dplyr::select(otu_df, Sample, Sample_Type2, Organ), by = "Sample") %>%  # Join reagent_tissue, vendor, and tissue_type columns
  group_by(Organ, Sample_Seq_Num) %>%
  summarize(Mean_Species = mean(Unique_Species), SEM = sqrt(var(Unique_Species)/length(Unique_Species))) %>%
  filter(!is.na(Organ))
 
rarefy_agg$Sample_Seq_Num <- as.numeric(rarefy_agg$Sample_Seq_Num)

pdf("Rarefaction_Curve_Mean_byType.pdf", height=6, width=6, useDingbats = FALSE)
ggplot(rarefy_agg, aes(x = Sample_Seq_Num, y = Mean_Species, color = Organ)) +
  geom_line(alpha = 0.5) + # Line for the mean
  geom_line(aes(y = Mean_Species - SEM), linetype = "dashed") + # Lower standard error
  geom_line(aes(y = Mean_Species + SEM), linetype = "dashed") + # Upper standard error
  geom_vline(xintercept=100)+
  geom_vline(xintercept=500)+
  geom_vline(xintercept=1000)+
  theme_bw() + 
  scale_y_continuous(limits=c(0,150)) +
  theme(panel.grid = element_blank(), legend.position = "top", legend.title = element_blank()) + 
  #scale_color_hue(labels = c("Charles River", "Jackson Labs", "Negative Controls")) + # Fix legend labels
  labs(x = "Number of Sequences Sampled", y = "Unique Species", title = "Rarefaction curves by type")
dev.off()

```


```{r rarefied richness - all tissue samples }

#Rarefaction curves can also be used to explore -diversity. First, the data needs to be prepared. 
#clean up raw count table
otu_raw_rare <- otu_raw
rownames(otu_raw_rare) <-  str_remove(string = rownames(otu_raw_rare), pattern = "_S\\d+_L001_R1_001") %>% str_remove(pattern = "_S\\d+_L001_R1") 
otu_raw_rare <- dplyr::select(otu_raw_rare, -label, -numOtus)

#exclude samples with low read count from analysis
otu_raw_rare <- dplyr::filter(otu_raw_rare, !(rownames(otu_raw_rare) %in% samples.to.exclude)) 

#remove Zymo mock positive controls
#tvl.rownames are the rownames of the samples we want to keep 
tvl.rownames <- vars_select(rownames(otu_raw_rare), !contains("Mock")) %>% as.data.frame() 
colnames(tvl.rownames) <- "Sample"
#next we want to left join to keep only samples from the whole raw count table we want to keep (aka non mocks)
#prep the cleaned up raw count table to be joined
div.rare.bl <- rownames_to_column(otu_raw_rare, var = "Sample")
#join to get rid of the unwanted samples
div.rare.bl <- left_join(tvl.rownames, div.rare.bl) %>% column_to_rownames(var = "Sample")

# Generate the rarefaction data, combine with metadata, transform for plotting, and aggregate
rarefy_agg <- rarefy(div.rare.bl, sample = 100) %>% 
as.data.frame() %>%
rownames_to_column("Sample")

colnames(rarefy_agg) <- c("Sample", "Unique_Taxa_per_100_reads")

rarefy_agg <- left_join(rarefy_agg, dplyr::select(otu_df, Sample, Organ, Sample_Type2), by = "Sample")

rarefy_agg_summary  <- rarefy_agg %>% 
                       group_by(Sample_Type2) %>%
                       summarize(Mean_Species = mean(Unique_Taxa_per_100_reads), 
                                 SEM = sqrt(var(Unique_Taxa_per_100_reads)/length(Unique_Taxa_per_100_reads)))
rarefy_agg$Sample_Type2 <- factor(rarefy_agg$Sample_Type2, 
                              levels = c("Empty", "Water",  "AE", "Iso_Ctrl","Syringe_Rinse", "PBS", "Homog_Ctrl","BAL", "Lung",  "Tongue", "Cecum"))

rarefy_agg_summary$Sample_Type2 <- factor(rarefy_agg_summary$Sample_Type2, 
                              levels = c("Empty", "Water",  "AE", "Iso_Ctrl","Syringe_Rinse", "PBS", "Homog_Ctrl","BAL", "Lung",  "Tongue", "Cecum"))

```

```{r plot_rarified_richness, fig.width=8, fig.height=4}

rich_pal <- c( "#EB3D0E", #scarlet - lung
               "#0300A6", # blue - BAL
              "#FB9986", #vivid tangerine - tongue
              "#0BDBA7", #sea foam green - sampling ctrls
              "#F2C121", #- isolation ctrls 
              "#666B6E" #- sequencing ctrls
        )

#pdf("Figure_3.pdf", height = 6, width=8, useDingbats = FALSE)
ggplot(rarefy_agg_summary, aes(x = Sample_Type2, y = Mean_Species, fill = Sample_Type2)) + # This brings in the aggregated dataframe and assigns columns to various plot elements
  geom_col(color="black", show.legend = FALSE) + # Add bars representing the mean of specimens' diversity
  geom_point(data = rarefy_agg, aes(x = Sample_Type2, y = Unique_Taxa_per_100_reads ), width = .2, show.legend = FALSE) + # Use specimen level data, map columns to scatterplot attributes
  geom_errorbar(aes(ymin = Mean_Species - SEM, ymax = Mean_Species + SEM), width = 0.5, size=0.7) + # Add an errorbar layer
  theme_classic() + # A minimalist theme
  theme(axis.title.y = element_text(face = "bold", size = 12), 
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 10),
        axis.title.x = element_text(face = "bold", size = 12), 
        plot.margin=unit(c(0.5,0.5,0.5,1), "cm")) +
  scale_y_continuous(limits = c(0,50), breaks = seq(0,50,10), expand = c(0,0)) + 
  labs(y = "Richness\n(No. of Unique OTUs/100 reads)\n", x = "\nSample Type") 
#dev.off()
```

```{r rarefied richness - hypothesis testing}
otu_df <- mutate(otu_df, Alpha_Div_Groups =  ifelse(test = Organ != "Lung", 
                                                 yes = as.character(Organ), 
                                                 no = as.character(Sample_Type))) %>% 
        dplyr::select(Sample:Gene_16S_copies_per_specimen, Alpha_Div_Groups, everything())

otu_df  <- left_join(otu_df, dplyr::select(rarefy_agg, Sample, Unique_Taxa_per_100_reads)) %>%
            dplyr::select(Sample:Gene_16S_copies_per_specimen, Unique_Taxa_per_100_reads, everything())

tukey_otu_df <- filter(otu_df, Sample_Type!="Mock" & Sample_Type!="Cecum" & Sample_Type!="Tongue")

TukeyHSD(aov(tukey_otu_df[,"Unique_Taxa_per_100_reads"] ~ tukey_otu_df[, "Alpha_Div_Groups"]))

```
\newpage
## 4.2 Alpha Diversity - Shannon Diversity Index
```{r plot_Shannon_diversity_index, fig.width=8, fig.height=5}
#calculate Shannon diversity indices for all samples
div.shan <- diversity(otu_good, "shannon") %>% data.frame(Shannon = .) %>% rownames_to_column("Sample") %>% left_join(otu_df[,1:6], by = "Sample")

otu_df  <- mutate(otu_df, Shannon = diversity(otu_good, "shannon")) %>% dplyr::select(Sample:Alpha_Div_Groups, Shannon, everything())

# Create summary statistics
agg_shan_all <- div.shan %>%
  group_by(Sample_Type2) %>%
  summarize(Mean_Sh = mean(Shannon), SEM_Sh = sqrt(var(Shannon)/length(Shannon))) 

agg_shan_all$Sample_Type2 <- factor(agg_shan_all$Sample_Type2, 
                              levels = c("Mock", "Empty", "Water",  "AE", "Iso_Ctrl","Syringe_Rinse", "PBS", "Homog_Ctrl","BAL", "Lung",  "Tongue", "Cecum"))
                              
agg_shan_all <- filter(agg_shan_all, Sample_Type2 != "Mock")


div.shan$Sample_Type2 <- factor(div.shan$Sample_Type2, levels = c("Mock", "Empty", "Water",  "AE", "Iso_Ctrl","Syringe_Rinse", "PBS", "Homog_Ctrl","BAL", "Lung",  "Tongue", "Cecum"))

div.shan <- filter(div.shan, Sample_Type2 != "Mock")

#pdf("Figure_S2.pdf", width = 8, height = 6, useDingbats = FALSE)
ggplot(agg_shan_all, aes(x = Sample_Type2, y = Mean_Sh, fill = Sample_Type2)) + # This brings in the aggregated dataframe and assigns columns to various plot elements
  geom_col(color="black", show.legend = FALSE) + # Add bars representing the mean of specimens' Shannon diversity by vendor
  geom_point(data = div.shan, aes(x = Sample_Type2, y = Shannon), width = .2, show.legend = FALSE) + # Use specimen level data, map columns to scatterplot attributes
  geom_errorbar(aes(ymin = Mean_Sh - SEM_Sh, ymax = Mean_Sh + SEM_Sh), width = 0.5, size=0.7) + # Add an errorbar layer
  theme_classic() + # A minimalist theme
  theme(axis.title.y = element_text(face = "bold", size = 15), 
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 10),
        axis.title.x = element_text(face = "bold", size = 15), 
        plot.margin=unit(c(0.5,0.5,0.5,1), "cm")) + 
  scale_y_continuous(limits = c(0,4), breaks = seq(0,4,1), expand = c(0,0)) + 
  labs(y = "Shannon Diversity Index\n", x = "\nSample Type") 
#dev.off()

```

```{r Shannon diversity index - hypothesis testing} 

tukey_otu_df <- dplyr::filter(otu_df, Sample_Type != "Mock" & Sample_Type != "Cecum" & Sample_Type != "Tongue")
TukeyHSD(aov(tukey_otu_df[,"Shannon"] ~ tukey_otu_df[, "Alpha_Div_Groups"]))

```

\newpage
## 4.3 Beta Diversity - Bray-Curtis dissimilarity Index within Sample Type

```{r Bray-Curtis_dissimilarity_by_sample_type}

bray_df_lbtce <- dplyr::filter(otu_df, Sample_Type2 == "Lung" | Sample_Type2 == "Tongue" | Sample_Type2 == "Cecum" | Sample_Type2 == "BAL" | Sample_Type2 == "Empty") %>%
  droplevels() %>% 
  column_to_rownames("Sample")  %>% # This turns the specimen column into the rownames.
  dplyr::select(-c(Sample_Type:Alpha_Div_Groups, Shannon))

#identify all unique comparisons within sample types 
sample_df <- rownames(bray_df_lbtce) %>% as.data.frame()
colnames(sample_df) <- c("Sample")
sample_df <- mutate(sample_df, Sample_Type = factor(str_extract(Sample, pattern="Lung|BAL|Tongue|Cecum|Blank")))
dim(sample_df) #[1] 83  2
comb_all <- combinations(n = 83, r = 2, v = sample_df$Sample) %>% as.data.frame()
colnames(comb_all) <- c("Sample", "Comparison")
comb_all_mut <- mutate(comb_all, Sample_Type = factor(str_extract(Sample, pattern="Lung|BAL|Tongue|Cecum|Blank")),
                                    Comparison_Type = factor(str_extract(Comparison, pattern="Lung|BAL|Tongue|Cecum|Blank")))
comb_uniq <- dplyr::filter(comb_all_mut, (Sample_Type == Comparison_Type))

#calculate distance, convert to symmetric matrix, and calculate row means (one mean per sample)
bray_dist_lbtce <- vegdist(bray_df_lbtce, method = "bray")
bray_dist_lbtce <- as.matrix(bray_dist_lbtce) %>% as.data.frame() %>% rownames_to_column(var="Sample")
bray_dist_lbtce <- dplyr::select(bray_dist_lbtce, Sample, everything())

bray_dist_lbtce_long <- pivot_longer(bray_dist_lbtce, -Sample, names_to = "Comparison", values_to = "BC_Index")
bray_dist_lbtce_long <- dplyr::filter(bray_dist_lbtce_long, Sample != Comparison)

bray_dist_lbtce_long_mut_filt_uniq <- left_join(comb_uniq, bray_dist_lbtce_long)

bray_dist_lbtce_summary <- group_by(bray_dist_lbtce_long_mut_filt_uniq, Sample) %>% 
                           summarize(Mean_BC = mean(BC_Index), SEM = sem(BC_Index)) 
            
bray_dist_lbtce_summary <- ungroup(bray_dist_lbtce_summary) %>% 
                          mutate(Sample_Type = factor(str_extract(Sample,pattern="Lung|BAL|Tongue|Cecum|Blank")))

bray_dist_lbtce_summary$Sample_Type <- factor(bray_dist_lbtce_summary$Sample_Type, 
                                     levels = c("Blank", "BAL","Lung", "Tongue", "Cecum"))

#pdf("Figure_4.pdf", height = 4, width = 6, useDingbats = FALSE)
ggplot(bray_dist_lbtce_summary, aes(x=Sample_Type, y = Mean_BC)) + 
  geom_boxplot(aes(fill=Sample_Type), show.legend = FALSE) + 
  geom_point() + 
  scale_y_continuous(limits = c(0,1.1), expand = c(0,0)) + 
  theme_classic() + 
  theme(axis.title.y = element_text(face = "bold", size = 15), 
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 10),
        axis.title.x = element_text(face = "bold", size = 15), 
        plot.margin=unit(c(0.5,0.5,0.5,1), "cm")) + 
  labs(y = "Bray-Curtis Dissimilarity\n", x = "\nSample Type") + 
  scale_fill_manual(values=c("#DBE6EC","#0300A6", "#EB3D0E", "#0BDBA7", "#0BDBA7"))
#dev.off()

ggplotly(p)
```

```{r Bray-Curtis dissimilarity by sample type - hypothesis testing}

pairwise.wilcox.test(bray_dist_lbtce_long_mut_filt_uniq$BC_Index, 
                     bray_dist_lbtce_long_mut_filt_uniq$Sample_Type, 
                     p.adjust.method = "BH")
```
\newpage
## 4.4 Bray-Curtis dissimilarity - Lung Samples vs. Matched Tongue Samples
```{r Bray_Curtis_dissimilarity_Lung_Samples_v_Matched_Tongue_Samples}

bray_df_tvbl <- dplyr::filter(otu_df, Organ == "Lung" | Organ == "Tongue") %>%
  droplevels() %>% 
  column_to_rownames("Sample")  %>% # This turns the specimen column into the rownames.
  dplyr::select(-c(Sample_Type:Shannon))

#calculate distance, convert to symmetric matrix, and calculate row means (one mean per sample)
bray_dist_tvbl <- vegdist(bray_df_tvbl, method = "bray")
bray_dist_tvbl <- as.matrix(bray_dist_tvbl) %>% as.data.frame() %>% rownames_to_column(var="Sample")

bray_dist_tvbl_long <- pivot_longer(bray_dist_tvbl, -Sample, names_to = "Comparison", values_to = "BC_Index")
bray_dist_tvbl_long <- dplyr::filter(bray_dist_tvbl_long, Sample != Comparison)

bray_dist_tvbl_long_mut <- dplyr::mutate(bray_dist_tvbl_long, 
                                    Sample_Mouse = factor(str_extract(Sample, pattern="L\\d+$|B\\d+$")), 
                                    Comparison_Mouse = factor(str_extract(Comparison, pattern="L\\d+$|B\\d+$")),
                                    Sample_Type = factor(str_extract(Sample, pattern="Lung|BAL|Tongue")),
                                    Comparison_Type = factor(str_extract(Comparison, pattern="Lung|BAL|Tongue")))


bray_dist_tvbl_long_mut_filt <- dplyr::filter(bray_dist_tvbl_long_mut, (Sample_Type != Comparison_Type) & (Sample_Mouse == Comparison_Mouse) & Sample_Type == "Tongue")


ggplot(bray_dist_tvbl_long_mut_filt, aes(x = Comparison_Type, y = BC_Index)) +
  geom_boxplot(aes(fill=Comparison_Type), show.legend = FALSE) + 
  geom_point() + 
  scale_y_continuous(limits = c(0,1.1), expand = c(0,0)) + 
  theme_classic() + 
  theme(axis.title.y = element_text(face = "bold", size = 15), 
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 10),
        axis.title.x = element_text(face = "bold", size = 15), 
        plot.margin=unit(c(0.5,0.5,0.5,1), "cm")) + 
  ylab("Bray-Curtis Dissimilarity\nto Matched Tongue Sample\n") + 
  scale_fill_manual(values=c( "#0300A6", "#EB3D0E"))


```

```{r Bray-Curtis dissimilarity- lung samples vs. matched tongue sample - hypothesis testing}

#Mann-Whitney U test
wilcox.test(BC_Index ~ Comparison_Type, data = bray_dist_tvbl_long_mut_filt)

```
\newpage
# V. Relative Abundance
## 5.1 Ordered by Lung OTUs

```{r plot_RA_Groups_ordered_by_Lung_OTUs, fig.height = 15, fig.width = 25}
otu_df <- dplyr::mutate(otu_df, RA_Groups = ifelse(test = is.na(RA_Groups), 
                                    yes = as.character(Sample_Type), 
                                    no = as.character(RA_Groups)
                                      )) %>% 
  dplyr::select(Sample:Shannon, RA_Groups, everything()) 

otu_df$RA_Groups <- as.factor(otu_df$RA_Groups)

gg.bal.lung.neg.tong.RAG.ordL <- filter(otu_df, Sample_Type != "Cecum" & Sample_Type != "Mock") %>% 
taxon_sort_gather(facet_var="RA_Groups", ord_val = "Lung") #%>% droplevels()

gg.bal.lung.neg.tong.RAG.ordL.ind <- filter(otu_df, Sample_Type != "Cecum" & Sample_Type != "Mock") %>% tsg_ind(sample_col = "Sample", otu_vec = levels(gg.bal.lung.neg.tong.RAG.ordL$OTU)) #%>% droplevels()

gg.bal.lung.neg.tong.RAG.ordL$RA_Groups <- factor(gg.bal.lung.neg.tong.RAG.ordL$RA_Groups, levels = c("Lung","Tongue", "BAL", "Negative Control"), labels = c("Lung","Tongue", "BAL", "Negative\nControls"))

gg.bal.lung.neg.tong.RAG.ordL.ind$RA_Groups <- factor(gg.bal.lung.neg.tong.RAG.ordL.ind$RA_Groups, levels = c("Lung","Tongue", "BAL", "Negative Control"), labels = c("Lung","Tongue", "BAL", "Negative\nControls"))

# #mean with individual points
# plot_ra(gg.bal.lung.neg.tong.RAG.ordL, fill = "RA_Groups", error_bar = T)+ facet_grid(RA_Groups~.) +
#   theme_bw() + 
#   geom_col(color="black", aes(fill=RA_Groups)) +
#    theme(axis.text.x = element_text(size = 20, angle = 45, hjust = 1, vjust=1), 
#          axis.text.y = element_text(size = 22),
#          axis.title.y = element_text(face = "bold", size = 30), 
#          axis.title.x = element_text(), 
#          strip.text = element_text(face = "bold", size = 25, angle = 0), 
#          strip.background = element_blank(),
#          panel.grid = element_blank(),
#          legend.position = "none", 
#          panel.spacing = unit(2, "lines"),
#          plot.margin=unit(c(0.5,0.5,0.5,6), "cm")) + 
#   scale_y_continuous(expand = c(0,0), limits = c(0,100), labels = dollar_format(suffix = "%", prefix = "")) + 
#   labs(y = "Relative Abundance (%)\n", x = "\nOTU") + 
#   scale_fill_manual(values=c("#EB3D0E", "#FB9986",  "#0300A6", "#666B6E")) + geom_point(data = gg.bal.lung.neg.tong.RAG.ordL.ind, aes(y = Percentage, 
#             x = OTU, alpha = 1, size = 7), color="black")

#mean only
#pdf("Figure_5D.pdf", height = 16, width=22, useDingbats = FALSE)
plot_ra(gg.bal.lung.neg.tong.RAG.ordL, fill = "RA_Groups", error_bar = T)+ facet_grid(RA_Groups~.) +
  theme_bw() + 
  geom_col(color="black", aes(fill=RA_Groups)) +
   theme(axis.text.x = element_text(size = 20, angle = 45, hjust = 1, vjust=1), 
         axis.text.y = element_text(size = 22),
         axis.title.y = element_text(face = "bold", size = 30), 
         axis.title.x = element_text(), 
         strip.text = element_text(face = "bold", size = 25, angle = 0), 
         strip.background = element_blank(),
         panel.grid = element_blank(),
         legend.position = "none", 
         panel.spacing = unit(2, "lines"),
         plot.margin=unit(c(0.5,0.5,0.5,6), "cm")) + 
  scale_y_continuous(expand = c(0,0), limits = c(0,25), labels = dollar_format(suffix = "%", prefix = "")) + 
  labs(y = "Relative Abundance (%)\n", x = "\nOTU") + 
  scale_fill_manual(values=c("#EB3D0E", "#FB9986",  "#0300A6", "#666B6E")) 
#dev.off()

# #median ordered by mean
# ggplot(gg.bal.lung.neg.tong.RAG.ordL.ind, aes(y=Percentage, x=OTU,  fill = RA_Groups)) +
#   geom_boxplot() + facet_grid(RA_Groups~.) + scale_y_continuous(expand = c(0,0), limits = c(0,50), labels = dollar_format(suffix = "%", prefix = ""))

```
## 5.2 Ordered by BAL Fluid OTUs

```{r plot_RA_Groups_ordered_by_BAL_OTUs, fig.height = 15, fig.width = 25}
otu_df <- dplyr::mutate(otu_df, RA_Groups = ifelse(test = is.na(RA_Groups), 
                                    yes = as.character(Sample_Type), 
                                    no = as.character(RA_Groups)
                                      )) %>% 
  dplyr::select(Sample:Shannon, RA_Groups, everything()) 

otu_df$RA_Groups <- as.factor(otu_df$RA_Groups)

gg.bal.lung.neg.tong.RAG.ordB <- filter(otu_df, Sample_Type != "Cecum" & Sample_Type != "Mock") %>% 
taxon_sort_gather(facet_var="RA_Groups", ord_val = "BAL")

gg.bal.lung.neg.tong.RAG.ordB$RA_Groups <- factor(gg.bal.lung.neg.tong.RAG.ordB$RA_Groups, levels = c("BAL", "Lung", "Negative Control", "Tongue"), labels = c("BAL","Lung", "Negative\nControls", "Tongue"))

plot_ra(gg.bal.lung.neg.tong.RAG.ordB, fill = "RA_Groups", error_bar = T) + facet_grid(RA_Groups~.) +
  theme_bw() + 
  geom_col(color="black", aes(fill=RA_Groups)) +
   theme(axis.text.x = element_text(size = 20, angle = 45, hjust = 1, vjust=1), 
         axis.text.y = element_text(size = 22),
         axis.title.y = element_text(face = "bold", size = 30), 
         axis.title.x = element_text(), 
         strip.text = element_text(face = "bold", size = 25, angle = 0), 
         strip.background = element_blank(),
         panel.grid = element_blank(),
         legend.position = "none", 
         panel.spacing = unit(2, "lines"),
         plot.margin=unit(c(0.5,0.5,6,6), "cm")) + 
  scale_y_continuous(expand = c(0,0), limits = c(0,25), labels = dollar_format(suffix = "%", prefix = "")) + 
  labs(y = "Relative Abundance (%)\n", x = "\nOTU") + 
  scale_fill_manual(values=c("#0300A6","#EB3D0E", "#666B6E", "#FB9986"))

```

## 5.3 Ordered by Pooled Negative Control OTUs

```{r plot_RA_Groups_ordered_by_neg_ctrl_OTUs, fig.height = 15, fig.width = 25}

gg.bal.lung.neg.tong.RAG.ordN <- filter(otu_df, Sample_Type != "Cecum" & Sample_Type != "Mock") %>% 
taxon_sort_gather(facet_var="RA_Groups", ord_val = "Negative Control")

gg.bal.lung.neg.tong.RAG.ordN$RA_Groups <- factor(gg.bal.lung.neg.tong.RAG.ordN$RA_Groups, levels = c("Negative Control", "BAL", "Lung", "Tongue"), labels = c("Negative\nControls", "BAL", "Lung", "Tongue"))

#pdf("Figure_S4B.pdf", width=22, height=16, useDingbats = FALSE)
plot_ra(gg.bal.lung.neg.tong.RAG.ordN, fill = "RA_Groups", error_bar = T) + facet_grid(RA_Groups~.) +
  theme_bw() + 
  geom_col(color="black", aes(fill=RA_Groups)) +
   theme(axis.text.x = element_text(size = 20, angle = 45, hjust = 1, vjust=1), 
         axis.text.y = element_text(size = 22),
         axis.title.y = element_text(face = "bold", size = 30), 
         axis.title.x = element_text(), 
         strip.text = element_text(face = "bold", size = 25, angle = 0), 
         strip.background = element_blank(),
         panel.grid = element_blank(),
         legend.position = "none", 
         panel.spacing = unit(2, "lines"),
         plot.margin=unit(c(0.5,0.5,0.5,6), "cm")) + 
  scale_y_continuous(expand = c(0,0), limits = c(0,27), labels = dollar_format(suffix = "%", prefix = "")) + 
  labs(y = "Relative Abundance (%)\n", x = "\nOTU") + 
  scale_fill_manual(values=c("#666B6E",  "#0300A6", "#EB3D0E", "#FB9986"))
#dev.off()

```

## 5.4 Ordered by Tongue OTUs

```{r plot_RA_Groups_ordered_by_tongue_OTUs, fig.height = 15, fig.width = 25}

gg.bal.lung.neg.tong.RAG.ordT <- filter(otu_df, Sample_Type != "Cecum" & Sample_Type != "Mock") %>% 
taxon_sort_gather(facet_var="RA_Groups", ord_val = "Tongue")

gg.bal.lung.neg.tong.RAG.ordT$RA_Groups <- factor(gg.bal.lung.neg.tong.RAG.ordT$RA_Groups, levels = c("Tongue",  "Lung","BAL", "Negative Control"), labels = c("Tongue", "Lung","BAL", "Negative\nControls"))

pdf("Figure_S4A.pdf", width=22, height=16, useDingbats = FALSE)
plot_ra(gg.bal.lung.neg.tong.RAG.ordT, fill = "RA_Groups", error_bar = T) + facet_grid(RA_Groups~.) +
  theme_bw() + 
  geom_col(color="black", aes(fill=RA_Groups)) +
   theme(axis.text.x = element_text(size = 20, angle = 45, hjust = 1, vjust=1), 
         axis.text.y = element_text(size = 22),
         axis.title.y = element_text(face = "bold", size = 30), 
         axis.title.x = element_text(), 
         strip.text = element_text(face = "bold", size = 25, angle = 0), 
         strip.background = element_blank(),
         panel.grid = element_blank(),
         legend.position = "none", 
         panel.spacing = unit(2, "lines"),
         plot.margin=unit(c(0.5,0.5,0.5,6), "cm")) + 
  scale_y_continuous(expand = c(0,0), limits = c(0,25), labels = dollar_format(suffix = "%", prefix = "")) + 
  labs(y = "Relative Abundance (%)\n", x = "\nOTU") + 
  scale_fill_manual(values=c("#FB9986", "#EB3D0E", "#0300A6", "#666B6E"))
dev.off()

```






